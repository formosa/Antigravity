.. _maggie-master:
.. <<<BEGIN-DDR>>>

================================================================================
MAGGIE — Development Documentation Roadmap (DDR)
================================================================================

**Single source of truth** for all requirements, architecture, and design decisions of the localized Python AI assistant application framework for the project named, "MAGGIE".

.. metadata:
   :file-id: ddr-root
   :title: "MAGGIE — Development Documentation Roadmap"
   :version: "5.0"
   :date: "2025-12-15"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"

.. contents::
   :local:
   :depth: 3
 
.. _glossary:
.. <<<BEGIN-GLOSSARY>>>
 
================================================================================
GLOSSARY OF CONTROLLED TERMS
================================================================================
 
.. metadata:
   :file-id: glossary
   :title: "GLOSSARY OF CONTROLLED TERMS"
   :version: "5.0"
   :date: "2025-12-16"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "1.0"
   :status: "Active"

.. _TERM-CORE-PROCESS:
Core Process
  :: The central orchestrator (never called "manager" or "controller").

.. _TERM-RUNTIME-PROCESS:
Runtime Process
  :: The GPU inference engine (never “model server”).

.. _TERM-AUDIO-PROCESS:
Audio Process
  :: CPU-bound audio I/O and WWD/VAD system.

.. _TERM-UI-PROCESS:
UI Process
  :: User interaction layer (PySide6 by default).

.. _TERM-TOOL:
Tool
  :: A modular capability extending |TERM-CORE-PROCESS| (not a process).

.. _TERM-ROUTINE:
Routine
  :: A workflow composed of |TERM-TOOL| objects and/or |TERM-SERVICE| objects.

.. _TERM-HSM:
HSM
  :: Hierarchical State Machine controlling orchestration inside the |TERM-CORE-PROCESS|.

.. _TERM-SERVICE:
Service
  :: A process with a DEALER socket (UI/Runtime/Audio).

.. _TERM-LOGSERVER:
LogServer
  :: The PULL-based logging aggregation process.

.. reconciliation_manifest:
   :section_id: glossary
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-16"
   :tag_count: 9
   :tag_inventory: ["TERM-CORE-PROCESS", "TERM-RUNTIME-PROCESS", "TERM-AUDIO-PROCESS", "TERM-UI-PROCESS", "TERM-TOOL", "TERM-ROUTINE", "TERM-HSM", "TERM-SERVICE", "TERM-LOGSERVER"]
   :pending_items: []
   
.. <<<END-GLOSSARY>>>


.. _doc-map:
.. <<<BEGIN-DOC-MAP>>>

================================================================================
LLM OPERATING MANUAL & PROTOCOLS
================================================================================

.. metadata:
   :file-id: doc-map
   :title: "LLM OPERATING MANUAL & PROTOCOLS"
   :purpose: "System Prompts and Invariants for AI Modification"
   :enforcement: STRICT
   :version: "5.0"
   :date: "2025-12-16"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "1.0"
   :status: "Active"


Protocol 1: Tag Topology & Persona
--------------------------------------------------------------------------------
The following tags define the content scope. When generating content for a tag, adopt the corresponding Persona.

- ``|BRD-*|`` :: [Context]    :: Persona: Strategist.     Input: Intent.       Output: Goals.
- ``|NFR-*|`` :: [Boundaries] :: Persona: SysAdmin.       Input: Hardware.     Output: Constraints.
- ``|FSD-*|`` :: [Behavior]   :: Persona: Product Owner.  Input: Requirements. Output: Capabilities.
- ``|SAD-*|`` :: [Structure]  :: Persona: Architect.      Input: Features.     Output: Patterns/Topology.
- ``|ICD-*|`` :: [Contracts]  :: Persona: Data Engineer.  Input: Topology.     Output: JSON/Schemas.
- ``|TDD-*|`` :: [Blueprints] :: Persona: Lead Dev.       Input: Contracts.    Output: Class Structure.
- ``|ISP-*|`` :: [Prompts]    :: Persona: Code Generator. Input: Blueprints.   Output: Python Stubs.

Protocol 2: Causal Hierarchy Order
--------------------------------------------------------------------------------
Flow: ``BRD → NFR → FSD → SAD → ICD → TDD → ISP``

Protocol 3: Integrity Directives
--------------------------------------------------------------------------------
1. **Glossary Compliance:** Validate all nouns against :ref:`glossary`. Error on non-compliant terms (e.g., "Manager" -> "Core Process").
2. **Traceability:** Every Child Tag MUST explicitly cite its Parent Tag(s). Syntax: ``← |PARENT_TAG|`` or ``← |PARENT_A|, |PARENT_B|``.
3. **Metadata Persistence:** Do not remove ``.. metadata:`` blocks. Increment ``version`` on edit.
4. **Marker Invariance:** Never modify ``.. <<<BEGIN-X>>>`` or ``.. <<<END-X>>>`` delimiters.
5. **Atomicity:** Updates to ``|ICD-*|`` (Schemas) must trigger immediate verification of ``|TDD-*|`` and ``|ISP-*|``.

Protocol 4: Vertical Consistency (Deferred Reconciliation)
--------------------------------------------------------------------------------
The documentation maintains consistency via a "Dirty Flag" system and strict Inventory Control.

1. **Inventory Maintenance (The Census Rule):**
   IF you Add or Remove a tag in the text,
   THEN you MUST update the ``:tag_inventory:`` list and ``:tag_count:`` integer in the ``reconciliation_manifest`` to match.
   *Bulk Deletion:* IF a Block Tag (e.g., |FSD-1|) is deleted, ALL Sub-Atomic tags (e.g., |FSD-1.1|...|FSD-1.9|) contained within it MUST be removed from the inventory.

2. **Downstream Invalidation (The Flagging Rule):**
   IF a Parent Tag is modified (e.g., |FSD-1| changes),
   THEN you must append an entry to the ``.. reconciliation_manifest:`` of the content section containing the Child Tag.
   *Action:* Set ``:integrity_status:`` to "DIRTY" and append a JSON object to ``pending_items`` using the following schema:
   ``{ "target_tag": "Child Tag ID", "source_trigger": "Modified Parent ID", "issue_type": "CONSTRAINT_VIOLATION", "description": "Details of conflict." }``

3. **Upstream Synthesis (The Orphan Rule):**
   IF a new Child Tag is created without a parent,
   THEN you must append an entry to the ``.. reconciliation_manifest:`` of the *parent's* expected section.
   *Action:* Flag the missing parent tag requirement using the schema:
   ``{ "target_tag": "Proposed Parent ID", "source_trigger": "New Orphan Child ID", "issue_type": "MISSING_PARENT", "description": "Required anchor for new content." }``

4. **Resolution:**
   Do not clear the manifest until a dedicated "Reconciliation Prompt" has successfully aligned the content.

Protocol 5: Tag Granularity & Lifecycle Standards
--------------------------------------------------------------------------------
You must apply the correct tagging resolution and maintain strict ID persistence.

1. **Block-Level Scope (Narrative):**
   *Trigger:* Headers, summary paragraphs, problem statements, or high-level descriptions.
   *Format:* ``|TAG-ID|`` (e.g., ``|BRD-5|``).
   *Placement:* inside the Header or at the end of the narrative block.

2. **Line-Level Scope (Atomic):**
   *Trigger:* **MANDATORY** for itemized lists of requirements, constraints, specifications, or data fields.
   *Format:* ``|TAG-ID.x|`` (e.g., ``|BRD-5.1|``).
   *Placement:* Append to the end of the specific line item.

3. **Lifecycle Stability (The Anti-Drift Rules):**
   *Immutable IDs:* ID Numbers are database keys, NOT ordinal steps. Never re-sequence or shift existing tags to fill gaps.
      - If ``.2`` is deleted, ``.3`` remains ``.3``.
   *Append-Only Generation:* New items inserted into a list MUST receive the next highest integer (e.g., ``.12``), regardless of visual position.
      - Correct: Visual List Order: "Step 1 |...1|", "Step 1.5 |...12|", "Step 2 |...2|".
   *No ID Recycling:* Never reuse a deleted ID. Always mint new.

4. **Citation Specificity (Leaf-Node Targeting):**
   IF a Parent Tag has Sub-Atomic children (e.g., ``|BRD-5|`` has ``.1`` through ``.6``),
   THEN downstream tags MUST cite the specific Child ID (e.g., ``← |BRD-5.4|``), NOT the generic Block ID.
   *Exception:* Cite the Block ID only if the requirement applies to the entire set universally.

5. **Atomic Inheritance (The List Rule):**
   *Context:* Atomic tags (e.g., ``|NFR-4.1|``) residing within their defined Block (e.g., ``|NFR-4|``) implicitly inherit the Block's context.
   *Rule:* DO NOT trace an Atomic Tag to its own Block Parent.
   *Prohibited:* ``|NFR-4.1| ← |NFR-4|`` (Redundant).
   *Allowed:* ``|NFR-4.1| ← |BRD-5.2|`` (External Authority).

6. **Inventory Registration:**
   Every generated sub-tag is a distinct entity. You must register it individually in the section's ``:tag_inventory:``.

6. **Lateral Dependency Prohibition (The Sibling Rule):**
   *Trigger:* Sub-atomic tags within the same block-level parent (e.g., |FSD-4.1| through |FSD-4.9|).
   *Rule:* DO NOT cite peer tags as parents (e.g., |FSD-4.4| ← |FSD-4.3| is PROHIBITED).
   *Rationale:* - Block-level membership already establishes contextual grouping.
   - Citations are strictly reserved for vertical (cross-layer) justification/authority.
   - Sequential relationships must be encoded in prose (e.g., "refinement of Stage 1 output").

.. reconciliation_manifest:
   :section_id: doc-map
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-16"
   :tag_count: 0
   :tag_inventory: []
   :pending_items: []

.. <<<END-DOC-MAP>>>


.. _brd-section:
.. <<<BEGIN-BRD>>>

================================================================================
BRD — Business Requirements (Context)
================================================================================

.. metadata:
   :file-id: brd-root
   :title: "Business Requirements"
   :version: "5.0"
   :date: "2025-12-16"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "1.0"
   :status: "Active"
   
Strategic Context
--------------------------------------------------------------------------------

.. _BRD-1:

Project Purpose |BRD-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Develop a fully offline-capable, high-performance, real-time Python AI assistant framework (MAGGIE).
It **must** integrate modular “Services” for local LLM inference, Text-to-Speech (TTS), Speech-to-Text (STT), and Wake Word Detection (WWD).
It **must** implement a modular event loop, “Routines” for task-specific application functionality, and provide extension via “Services”, “Tools”, and “Routines”.

.. _BRD-2:

Strategic Objective |BRD-2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Enable responsive, privacy-preserving AI assistant capabilities without dependency on cloud infrastructure.
The system **must** ensure fault tolerance, maintainability, and deterministic state transitions via an HSM.

.. _BRD-3:

Business Rationale |BRD-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Privacy & Offline:** Enable operation without internet dependency or data leakage. |BRD-3.1|
- **Customizability:** Allow extension via a modular architecture. |BRD-3.2|
- **Performance:** Leverage local GPU resources for low-latency performance. |BRD-3.3|
- **Reliability:** Reduce downtime through multi-process isolation. |BRD-3.4|
- **Observability:** Enhance debugging via distributed, correlated logging. |BRD-3.5|

.. _BRD-4:

Problem Statement |BRD-4|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Users require AI assistant capabilities but are constrained by internet dependency, privacy concerns, and the limitations of single-process applications.
The framework requires a high-performance, non-blocking, and fault-isolating Inter-Process Communication (IPC) architecture.

System Scope
--------------------------------------------------------------------------------

.. _BRD-5:

High-level Scope |BRD-5|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- Offline, multi-process Python framework. |BRD-5.1|
- Local LLM, TTS, and STT inference. |BRD-5.2|
- Modular "Tool" and "Routine" expansion system. |BRD-5.3|
- Centralized, correlated logging. |BRD-5.4|
- Intuitive UI for control and state feedback. |BRD-5.5|
- Hierarchical State Machine (HSM) for orchestration. |BRD-5.6|

.. _BRD-6:

Constraints & Environment |BRD-6|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Target Environment:** High-end consumer workstation. |BRD-6.1|
- **Operation:** Real-time operation with limited blocking tolerance. |BRD-6.2|
- **Security:** Local sockets only (127.0.0.1). |BRD-6.3|

Success Criteria
--------------------------------------------------------------------------------

.. _BRD-7:

Stakeholders |BRD-7|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Primary:** End users requiring offline AI assistant functionality. |BRD-7.1|
- **Secondary:** Developers extending Maggie via Tools/Routines. |BRD-7.2|
- **Tertiary:** DevOps and QA Engineers (monitoring, testing). |BRD-7.3|

.. _BRD-8:

Success Metrics |BRD-8|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Latency:** Sub-250ms IPC dispatch; <1s LLM response. |BRD-8.1|
- **Reliability:** 99.9% Core uptime; mean uptime >= 72 hours. |BRD-8.2|
- **Observability:** 100% request traceability. |BRD-8.3|

Future Work
--------------------------------------------------------------------------------

.. _BRD-9:

Future Scope (Out of Initial Scope) |BRD-9|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- Persistent HSM state for crash recovery. |BRD-9.1|
- Multi-GPU ONNX worker pool. |BRD-9.2|
- Real-time streaming for TTS/STT. |BRD-9.3|
- Metrics dashboard with live state visualization. |BRD-9.4|
- Request cancellation support. |BRD-9.5|
- Remote/distributed ONNX deployment. |BRD-9.6|
- Offline speaker diarization. |BRD-9.7|

.. reconciliation_manifest:
   :section_id: brd-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-16"
   :tag_count: 36
   :tag_inventory: ["BRD-1", "BRD-2", "BRD-3", "BRD-3.1", "BRD-3.2", "BRD-3.3", "BRD-3.4", "BRD-3.5", "BRD-4", "BRD-5", "BRD-5.1", "BRD-5.2", "BRD-5.3", "BRD-5.4", "BRD-5.5", "BRD-5.6", "BRD-6", "BRD-6.1", "BRD-6.2", "BRD-6.3", "BRD-7", "BRD-7.1", "BRD-7.2", "BRD-7.3", "BRD-8", "BRD-8.1", "BRD-8.2", "BRD-8.3", "BRD-9", "BRD-9.1", "BRD-9.2", "BRD-9.3", "BRD-9.4", "BRD-9.5", "BRD-9.6", "BRD-9.7"]
   :pending_items: []

.. <<<END-BRD>>>


.. _nfr-section:
.. <<<BEGIN-NFR>>>

================================================================================
NFR — System Constraints (Boundaries)
================================================================================

.. metadata:
   :file-id: nfr-root
   :title: "System Constraints"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Define Hard Limits & Constraints"

Hardware & Environment Limits
--------------------------------------------------------------------------------

.. _NFR-1:

Target Environment |NFR-1| ← |BRD-6|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **CPU:** AMD Ryzen 9 5900X (Audio/Core must run here). |NFR-1.1|
- **GPU:** RTX 3080 10GB VRAM (Runtime/Inference only). |NFR-1.2|
- **RAM:** 32GB System Memory. |NFR-1.3|
- **OS:** Windows 11 Pro x64. |NFR-1.4|
- **Python:** Version >= 3.11. |NFR-1.5|
- **CUDA:** Toolkit installed for GPU inference. |NFR-1.6|

.. _NFR-2:

Security & Network |NFR-2| ← |BRD-3|, |BRD-6|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- All communication limited to local TCP sockets (`127.0.0.1`) via ZeroMQ. |NFR-2.1|
- No cloud dependencies allowed for runtime operations. |NFR-2.2|

.. _NFR-3:

Resource Isolation |NFR-3| ← |BRD-3|, |BRD-6|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **CPU Idle:** Processes polling for IPC messages must consume <5% CPU when idle. |NFR-3.1|
- **Audio Priority:** CPU-bound services (Audio) must prioritize low-latency over idle CPU. |NFR-3.2|
- **Memory Footprint (Core Queue):** 1000 cap, ~10-50 MB. |NFR-3.3|
- **Memory Footprint (UI Queue):** 100 cap, ~1-5 MB. |NFR-3.4|
- **Memory Footprint (Runtime Queue):** 50 cap, ~5-25 MB. |NFR-3.5|
- **Memory Footprint (Audio Queue):** 50 cap, ~1-5 MB. |NFR-3.6|

Performance Targets
--------------------------------------------------------------------------------

.. _NFR-4:

Latency & Throughput |NFR-4| ← |BRD-5.2|, |BRD-8|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **IPC Dispatch:** Sub-millisecond (<1ms) for metadata-only messages. |NFR-4.1|
- **Round Trip:** <5ms metadata-only; <20ms for 1MB payload (excluding processing). |NFR-4.2|
- **LLM Inference:** <1s average response time. |NFR-4.3|
- **TTS:** ≤2s average end-to-end response. |NFR-4.4|
- **UI Responsiveness:** No input blocking >100ms. |NFR-4.5|
- **Logging:** LogServer must support ≥ 10,000 msgs/sec. |NFR-4.6|
- **HSM:** Must support ≥ 1,000 state transitions/sec. |NFR-4.7|
- **Queue Operations:** O(log n) time (1-5 microseconds). |NFR-4.8|

Reliability Constraints
--------------------------------------------------------------------------------

.. _NFR-5:

Fault Tolerance |NFR-5| ← |BRD-2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Non-blocking:** No process shall block waiting for another during standard IPC. |NFR-5.1|
- **Isolation:** Failures in UI, Runtime, or Audio must not cascade to Core. |NFR-5.2|
- **Fire-and-Forget:** Log messages are acceptable to be lost if LogServer is down. |NFR-5.3|
- **Timeout Accuracy:** Detection must be within ±100ms of configured limit. |NFR-5.4|
- **Core Failure:** In-flight requests are considered lost (MVP acceptable). |NFR-5.5|
- **Message Routability:** The Core must explicitly detect and handle attempts to send messages to disconnected or non-existent service identities. |NFR-5.6|

.. _NFR-6:

Key Dependencies |NFR-6| ← |BRD-6|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- `PySide6`: Default GUI framework. |NFR-6.1|
- `pyzmq`: Non-blocking IPC. |NFR-6.2|
- `onnxruntime-gpu`: GPU inference. |NFR-6.3|
- `loguru`: Distributed logging. |NFR-6.4|
- `transitions`: HSM implementation. |NFR-6.5|

.. reconciliation_manifest:
   :section_id: nfr-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 39
   :tag_inventory: ["NFR-1", "NFR-1.1", "NFR-1.2", "NFR-1.3", "NFR-1.4", "NFR-1.5", "NFR-1.6", "NFR-2", "NFR-2.1", "NFR-2.2", "NFR-3", "NFR-3.1", "NFR-3.2", "NFR-3.3", "NFR-3.4", "NFR-3.5", "NFR-3.6", "NFR-4", "NFR-4.1", "NFR-4.2", "NFR-4.3", "NFR-4.4", "NFR-4.5", "NFR-4.6", "NFR-4.7", "NFR-4.8", "NFR-5", "NFR-5.1", "NFR-5.2", "NFR-5.3", "NFR-5.4", "NFR-5.5", "NFR-5.6", "NFR-6", "NFR-6.1", "NFR-6.2", "NFR-6.3", "NFR-6.4", "NFR-6.5"]
   :pending_items: []

.. <<<END-NFR>>>


.. _fsd-section:
.. <<<BEGIN-FSD>>>

================================================================================
FSD — Feature Specifications (Behavior)
================================================================================

.. metadata:
   :file-id: fsd-root
   :title: "Feature Specifications"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Define System Behavior and Capabilities"

System Core Capabilities
--------------------------------------------------------------------------------

.. _FSD-1:

Process Orchestration |FSD-1| ← |BRD-5|, |NFR-5|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
The system must maintain independent but interconnected processes utilizing a multi-process architecture:
- **Core (Hub):** Routes request-response messages between services and tracks in-flight requests via `request_id`. |FSD-1.1|
- **Services (Spokes):**
  - **UI Process:** Handles user interaction (PySide6). |FSD-1.2|
  - **Runtime Process:** GPU-optimized environment for model inference. |FSD-1.3|
  - **Audio Process:** Real-time audio I/O, WWD, and VAD. |FSD-1.4|
- **LogServer (Sink):** Aggregates logs via PULL socket. |FSD-1.5|

.. _FSD-2:

Hierarchical State Machine (HSM) |FSD-2| ← |BRD-2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- Core must maintain an HSM (using `transitions` library). |FSD-2.1|
- **Dynamic Compilation:** HSM must be dynamically compiled at startup from definitions provided by Tools, Routines, and Services. |FSD-2.2|
- **Required States:** `Root(DEFAULT)`, `initializing`, `sleeping`, `waking`, `active`, `busy` (`llm`, `tts`, `stt`), `error`, `shutting_down`. |FSD-2.3|
- **Transitions:** |FSD-2.4|
  - `sleeping` (Start): Low power, UI Dark, Input Locked.
  - `waking`: Triggered by `WAKE_WORD` or `GUI_INTERACTION`.
  - `active`: Normal operation, UI Bright, Input Unlocked.

.. _FSD-3:

Modular Extensions (Tools/Routines) |FSD-3| ← |BRD-5|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Tools:** Modular functional assets with specific HSM states (e.g., File Export). |FSD-3.1|
- **Routines:** Structured workflows composed of Tools and Services (e.g., Recipe Creator). |FSD-3.2|
- **Default Routine:** A "Primary Routine" providing conversational LLM chat mapping GUI inputs to CLI commands. |FSD-3.3|

Voice Interaction Pipeline
--------------------------------------------------------------------------------

.. _FSD-4:

Audio Acquisition (Audio Service) |FSD-4| ← |BRD-5|, |NFR-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Wake Word:** Always-on detection using `pvporcupine`. |FSD-4.1|
- **Constraint:** Must only send `WAKE_WORD_DETECTED` if Core is in `idle` state. |FSD-4.2|
- **VAD (Stage 1):** Real-time, CPU-based VAD using `webrtcvad`. |FSD-4.3|
- **VAD (Stage 2):** Neural VAD (Silero via ONNX Runtime CPU) runs locally in Audio Process. Refines |FSD-4.3| output. |FSD-4.4| ← |BRD-5.2|, |NFR-1.1| ← |NFR-1|
- **Signal Output:** Emits normalized `SIGNAL_SPEECH` (Text) or `SIGNAL_WAKE` (Event) to Core. No command interpretation. |FSD-4.5|

.. _FSD-5:

Inference Execution (Runtime Service) |FSD-5| ← |BRD-5|, |NFR-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **STT:** Execute transcription using `faster-whisper` (ONNX) on audio buffers routed from Audio Service. |FSD-5.1|
- **LLM:** Execute text generation using local models via ONNX Runtime. |FSD-5.2|
- **TTS:** Execute synthesis using `kokoro` (ONNX). |FSD-5.3|
- **Error Handling:** Must report clear error codes (e.g., `ONNX_E_CUDA_OOM`). |FSD-5.4|

Logging & Observability
--------------------------------------------------------------------------------

.. _FSD-6:

Distributed Logging |FSD-6| ← |BRD-3|, |NFR-5|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- All processes must emit logs to the central LogServer. |FSD-6.1|
- **Fire-and-Forget:** Senders must never block; messages are dropped if LogServer is down. |FSD-6.2|
- **Correlation:** All logs must include `request_id` for correlation across processes. |FSD-6.3|
- **Traceability:** 100% traceable request coverage. |FSD-6.4|

.. _FSD-7:

Error Handling Strategy |FSD-7| ← |BRD-2|, |NFR-5|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **LogServer Fault:** Senders continue normally, silently dropping logs. |FSD-7.1|
- **Service Fault:** Core detects disconnection, marks service unavailable, transitions requests to error. |FSD-7.2|
- **Timeout:** Core detects non-response (>5.0s) and triggers error state. |FSD-7.3|
- **Core Fault:** Services remain operational but disconnected; attempt reconnect on restart. |FSD-7.4|

.. _FSD-8:

Intent Resolution (The "Brain") |FSD-8| ← |BRD-5.6|, |FSD-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Input Normalization:** Core accepts inputs (`VOICE`, `CLI`, `GUI`) as uniform text strings. |FSD-8.1|
- **Command Registry:** Core maintains a registry of valid commands mapping "String" → "Callable". |FSD-8.2|
- **Fast Path:** IF input matches Registry Key → Execute immediately (Deterministic). |FSD-8.3|
- **Slow Path:** IF input does not match → Forward to LLM Service for inference (Probabilistic). |FSD-8.4|

.. _FSD-9:

User Experience (UX) |FSD-9| ← |BRD-5.5|, |FSD-1.2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **State Reflection:** UI must visually reflect state (Dark/Gray for Sleep, Bright/Color for Active). |FSD-9.1|
- **Input Locking:** Text input disabled in Sleep; Blinking cursor only in Active. |FSD-9.2|
- **Wake Triggers:** System wakes on Voice ("Hey Maggie") OR Click-to-Wake on input box. |FSD-9.3|
- **Audio Feedback:** |FSD-9.4|
  - *Sleep -> Waking (Click):* Play "Yes? Just one moment, please."
  - *Waking -> Active:* Play "How can I assist you."

.. reconciliation_manifest:
   :section_id: fsd-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 46
   :tag_inventory: ["FSD-1", "FSD-1.1", "FSD-1.2", "FSD-1.3", "FSD-1.4", "FSD-1.5", "FSD-2", "FSD-2.1", "FSD-2.2", "FSD-2.3", "FSD-2.4", "FSD-3", "FSD-3.1", "FSD-3.2", "FSD-3.3", "FSD-4", "FSD-4.1", "FSD-4.2", "FSD-4.3", "FSD-4.4", "FSD-4.5", "FSD-5", "FSD-5.1", "FSD-5.2", "FSD-5.3", "FSD-5.4", "FSD-6", "FSD-6.1", "FSD-6.2", "FSD-6.3", "FSD-6.4", "FSD-7", "FSD-7.1", "FSD-7.2", "FSD-7.3", "FSD-7.4", "FSD-8", "FSD-8.1", "FSD-8.2", "FSD-8.3", "FSD-8.4", "FSD-9", "FSD-9.1", "FSD-9.2", "FSD-9.3", "FSD-9.4"]
   :pending_items: []

.. <<<END-FSD>>>


.. _sad-section:
.. <<<BEGIN-SAD>>>

================================================================================
SAD — Architecture Definitions (Structure)
================================================================================

.. metadata:
   :file-id: sad-root
   :title: "Architecture Definitions"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Define Architecture & Patterns"

.. _SAD-1:

Architectural Patterns |SAD-1| ← |FSD-1.1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Hub-and-Spoke:** Core Process acts as the central `ROUTER` (Hub); Services are `DEALER` (Spokes). |SAD-1.1|
- **Decoupled Sink:** Dedicated LogServer acts as `PULL` sink for `PUSH` sources. |SAD-1.2|
- **No Shared Abstraction:** `ROUTER-DEALER` and `PUSH-PULL` patterns are implemented separately to avoid artificial coupling. |SAD-1.3|
- **Context Propagation:** `request_id` must be passed in every frame. |SAD-1.4|

.. _SAD-2:

Process Topology |SAD-2| ← |FSD-1.1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. code-block:: text

   +---------------+          +------------------+          +-----------------+
   |  UI (DEALER)  | <------> |   Core (ROUTER)  | <------> | Runtime (DEALER)|
   +---------------+          +------------------+          +-----------------+
           |                     ^             |                     |
           |                     |             |                     |
           |            +------------------+   |                     |
           |            |  Audio (DEALER)  |   |                     |
           |            +------------------+   |                     |
           |                     |             |                     |
           v                     v             v                     v
   +-------------------------------------------------------------------------+
   |                            LogServer (PULL)                             |
   +-------------------------------------------------------------------------+
                                       ^
                                       |
                   (All "Push" connections are Fire-and-Forget)

   Legend:
   <--->  : Bidirectional Request-Response (ROUTER-DEALER)
   ---->  : Unidirectional Fire-and-Forget (PUSH-PULL)

.. _SAD-3:

Integration Strategy |SAD-3| ← |FSD-6.1|, |NFR-2.1| ← |NFR-2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Core ↔ Services (Request-Response):** |SAD-3.1|
  - **Pattern:** ZeroMQ `ROUTER` (Core) ↔ `DEALER` (Service). |SAD-3.2|
  - **Type:** Bidirectional. |SAD-3.3|
  - **Requirement:** Core maintains routing table (client identity → socket identity). |SAD-3.4|
- **All Processes → LogServer (Logging):** |SAD-3.5|
  - **Pattern:** ZeroMQ `PUSH` (Client) → `PULL` (LogServer). |SAD-3.6|
  - **Type:** Unidirectional, Fire-and-Forget. |SAD-3.7|
  - **Requirement:** Senders must set `SNDHWM=100` and `LINGER=0` to buffer micro-bursts without blocking. |SAD-3.8|

.. _SAD-4:

Concurrency Model |SAD-4| ← |NFR-5.1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Receiver Threads:** Each process uses a dedicated thread to poll ZMQ sockets and push to an internal `queue.PriorityQueue`. |SAD-4.1|
- **Main Loop:** The main application loop processes the `PriorityQueue` to remain non-blocking. |SAD-4.2|
- **Queueing:** |SAD-4.3|
  - Must use `queue.PriorityQueue`. |SAD-4.4|
  - **Structure:** `(priority, counter, message)`. |SAD-4.5|
  - **Ordering:** Monotonic counter (`itertools.count`) ensures FIFO within priority levels. |SAD-4.6|
- **Priority Levels:** |SAD-4.7|
  - **High (0):** `shutdown`, `error_notification`, `state_change`. |SAD-4.8|
  - **Normal (1):** Inference requests, status updates. |SAD-4.9|

.. _SAD-5:

Configuration Driven |SAD-5| ← |BRD-3.2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- All IPC endpoints (addresses, ports) and parameters (queue sizes, timeouts) must be loaded from `ipc_config.yaml`. |SAD-5.1|

.. reconciliation_manifest:
   :section_id: sad-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 27
   :tag_inventory: ["SAD-1", "SAD-1.1", "SAD-1.2", "SAD-1.3", "SAD-1.4", "SAD-2", "SAD-3", "SAD-3.1", "SAD-3.2", "SAD-3.3", "SAD-3.4", "SAD-3.5", "SAD-3.6", "SAD-3.7", "SAD-3.8", "SAD-4", "SAD-4.1", "SAD-4.2", "SAD-4.3", "SAD-4.4", "SAD-4.5", "SAD-4.6", "SAD-4.7", "SAD-4.8", "SAD-4.9", "SAD-5", "SAD-5.1"]
   :pending_items: []

.. <<<END-SAD>>>


.. _icd-section:
.. <<<BEGIN-ICD>>>

================================================================================
ICD — Interface & Data Schemas (Contracts)
================================================================================

.. metadata:
   :file-id: icd-root
   :title: "Interface & Data Schemas"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Define Data Shapes and Contracts"

Configuration Schemas
--------------------------------------------------------------------------------

.. _ICD-1:

IPC Configuration (ipc_config.yaml) |ICD-1| ← |SAD-5.1|, |NFR-3.3|, |NFR-3.4|, |NFR-3.5|, |NFR-3.6| ← |NFR-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. code-block:: yaml

   core:
     router_bind: "tcp://127.0.0.1:5555"
     push_connect: "tcp://127.0.0.1:5556"    # Added for Core logging
     router_hwm: 1000
     queue_maxsize: 1000
     poll_timeout_ms: 100
     response_timeout_s: 5.0
     extensions:
       path: "./extensions"      # Root for tools/routines discovery

   logserver:
     pull_bind: "tcp://127.0.0.1:5556"
     poll_timeout_ms: 1      # Tight loop for high throughput
     log_rotation_mb: 50
     log_retention_days: 30

   services:
     ui:
       dealer_connect: "tcp://127.0.0.1:5555"
       push_connect: "tcp://127.0.0.1:5556"
       queue_maxsize: 100
       poll_timeout_ms: 100
     runtime:
       dealer_connect: "tcp://127.0.0.1:5555"
       push_connect: "tcp://127.0.0.1:5556"
       queue_maxsize: 50
       poll_timeout_ms: 100
     audio:
       dealer_connect: "tcp://127.0.0.1:5555"
       push_connect: "tcp://127.0.0.1:5556"
       queue_maxsize: 50
       poll_timeout_ms: 10

Message Protocols
--------------------------------------------------------------------------------

.. _ICD-2:

Frame Structure |ICD-2| ← |SAD-3.2|, |SAD-3.6|, |SAD-1.4| ← |SAD-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Core ↔ Services (ROUTER-DEALER):** |ICD-2.1|
  - **Outbound (DEALER):** `[metadata_json, payload_bytes...]` |ICD-2.2|
  - **Inbound (ROUTER):** `[service_identity, b'', metadata_json, payload_bytes...]` |ICD-2.3|
- **All → LogServer (PUSH-PULL):** |ICD-2.4|
  - **Frame:** `[metadata_json, message_string]` |ICD-2.5|
- **Payloads:** |ICD-2.6|
  - Text: JSON-encoded UTF-8 bytes. |ICD-2.7|
  - Binary: Raw bytes (PCM, tensors). |ICD-2.8|
  - Multi-part: Supported for zero-copy efficiency. |ICD-2.9|

.. _ICD-3:

Metadata Schema (JSON) |ICD-3| ← |FSD-6.3|, |SAD-4.7| ← |SAD-4|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Every IPC message frame 0 (Metadata) must validate against:

.. code-block:: json

   {
     "source": "UI | Audio | Runtime | Core",
     "destination": "Target_Service_Name",
     "command": "function_name_or_signal",
     "request_id": "uuid-v4-string",
     "timestamp": "ISO-8601-string",
     "priority": 1,
     "payload_type": "json | binary | text"
   }
   // Note: Priority 0 = High, 1 = Normal

.. _ICD-4:

Response Payload Schema |ICD-4| ← |ICD-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. code-block:: json

   {
     "source": "Runtime",
     "destination": "UI",
     "command": "llm_inference_response",
     "request_id": "uuid-echoed",
     "timestamp": "ISO-8601-string",
     "status": "success | error",
     "error_code": "optional_string_or_null"
   }

.. reconciliation_manifest:
   :section_id: icd-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 13
   :tag_inventory: ["ICD-1", "ICD-2", "ICD-2.1", "ICD-2.2", "ICD-2.3", "ICD-2.4", "ICD-2.5", "ICD-2.6", "ICD-2.7", "ICD-2.8", "ICD-2.9", "ICD-3", "ICD-4"]
   :pending_items: []

.. <<<END-ICD>>>


.. _tdd-section:
.. <<<BEGIN-TDD>>>

================================================================================
TDD — Technical Design (Blueprints)
================================================================================

.. metadata:
   :file-id: tdd-root
   :title: "Technical Design"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Define Component Structure (No Logic)"

Component Blueprints
--------------------------------------------------------------------------------

.. _TDD-1:

Component: CoreProcess |TDD-1| ← |SAD-2|, |FSD-1.1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Class Name:** `CoreProcess` |TDD-1.1|
- **Dependencies:** `zmq`, `queue`, `itertools`, `transitions`, `yaml`, `threading`, `importlib`, `pathlib`. |TDD-1.2|
- **Socket Configuration:**
  - Bind `ROUTER` socket to address defined in `ipc_config.yaml` (`core.router_bind`). |TDD-1.3| ← |ICD-1|, |SAD-3.2| ← |SAD-3|
  - Connect `PUSH` socket to `core.push_connect` (SNDHWM=1, LINGER=0) for logging. |TDD-1.10| ← |FSD-6.1|, |SAD-3.5| ← |SAD-3|
  - Set `ZMQ_ROUTER_MANDATORY=1` to detect unroutable messages. |TDD-1.4| ← |NFR-5.6| ← |NFR-5|
- **State Management:**
  - Initialize `active_requests` dictionary: `Dict[str, Tuple[bytes, float, str]]` (ID → Identity, Timestamp, Command). |TDD-1.5| ← |SAD-1.4| ← |SAD-1|
  - Initialize HSM using `transitions.Machine`. State definitions include both statically-defined core states and dynamically-compiled states from Tool/Routine extensions. |TDD-1.6| ← |FSD-2.2|, |FSD-2.3| ← |FSD-2|
- **Concurrency (Main Loop):**
  - **Receiver Thread:** Spawns a `threading.Thread` to poll the `ROUTER` socket and push frames to `self.queue`. |TDD-1.7| ← |SAD-4.1| ← |SAD-4|
  - **Event Loop:** Pops items from `self.queue` (PriorityQueue) and dispatches to HSM triggers. |TDD-1.8| ← |SAD-4.2| ← |SAD-4|
  - **Timeout Monitor:** On every loop iteration, check `active_requests` for timestamps exceeding `response_timeout_s`. |TDD-1.9| ← |FSD-7.3| ← |FSD-7|
- **Extension Discovery:**
  - **Scan Logic:** On startup, iterate directories in `config.core.extensions.path`. |TDD-1.11| ← |FSD-3|
  - **Validation:** Parse `manifest.yaml` in subdirectories (`tools/`, `routines/`). |TDD-1.12|
  - **Loading:** Use `importlib` to dynamically import the module specified in manifest `entry_point`. |TDD-1.13|
- **Command Resolution:**
  - **Structure:** `self.command_registry: Dict[str, Callable]`. |TDD-1.14| ← |FSD-8.2| ← |FSD-8|
  - **Logic:** `resolve_intent(input_str: str)` checks registry before HSM dispatch. |TDD-1.15|

.. _TDD-2:

Component: ServiceClient |TDD-2| ← |SAD-3.1|, |SAD-4|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Class Name:** `ServiceClient` |TDD-2.1|
- **Purpose:** Standardized base implementation for UI, Runtime, and Audio services. |TDD-2.2|
- **Dependencies:** `yaml`, `zmq`, `queue`, `itertools`, `threading`. |TDD-2.3|
- **Socket Configuration:**
  - `DEALER`: Connects to Core `ROUTER`. Identity is auto-assigned by ZMQ. |TDD-2.4| ← |ICD-2.1| ← |ICD-2|
  - `PUSH`: Connects to LogServer `PULL`. Must set `SNDHWM=1` and `LINGER=0` (Fire-and-Forget). |TDD-2.5| ← |SAD-3.8|, |NFR-5.3| ← |NFR-5|
- **Queuing Strategy:**
  - Internal `queue.PriorityQueue` populated by a dedicated `_receiver_thread`. |TDD-2.6| ← |SAD-4.1| ← |SAD-4|
  - Internal `queue.PriorityQueue` populated by a dedicated `_receiver_thread`. |TDD-2.6| ← |SAD-4.1|
  - Ordering enforced via `(priority, itertools.count(), message)` tuple. |TDD-2.7| ← |SAD-4.6|
- **UI Requirements:**
  - **State Awareness:** Must subscribe to HSM state changes and apply CSS classes (`sleeping`, `active`). |TDD-2.8| ← |FSD-9.1|
  - **Input Control:** Widget `setReadOnly(True)` in Sleep; `installEventFilter` to catch Click-to-Wake events. |TDD-2.9| ← |FSD-9.2| ← |SAD-4|

.. _TDD-3:

Component: LogServerSink |TDD-3| ← |FSD-6.1|, |ICD-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Class Name:** `LogServerSink` |TDD-3.1|
- **Dependencies:** `loguru`, `zmq`. |TDD-3.2|
- **Socket Configuration:**
  - Bind `PULL` socket to address defined in `ipc_config.yaml` (`logserver.pull_bind`). |TDD-3.3| ← |SAD-3.6| ← |SAD-3|
- **Processing Loop:**
  - Execute tight poll loop (1ms timeout) to maximize throughput. |TDD-3.4| ← |NFR-4.6| ← |NFR-4|
  - Parse inbound frames as `[metadata_json, message_string]`. |TDD-3.5| ← |ICD-2.5| ← |ICD-2|
- **Persistence:**
  - Configure `loguru` rotation (50MB) and retention (30 days). |TDD-3.6| ← |ICD-1|

Interface Contracts
--------------------------------------------------------------------------------

.. _TDD-4:

Component: Tool/Routine Interface |TDD-4| ← |FSD-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- **Class Name:** `AbstractTool`, `AbstractRoutine` (ABC). |TDD-4.1|
- **Abstract Methods:**
  - `initialize(core_context: CoreProcess)`: Inject Core dependencies. |TDD-4.2|
  - `get_hsm_states() -> List[Dict]`: Return state definitions for dynamic compilation. |TDD-4.3| ← |FSD-2.2| ← |FSD-2|
  - `handle_event(event_data: Dict) -> str`: Process business logic and return next trigger. |TDD-4.4|
- **Manifest Contract:**
  - **Requirement:** Every extension directory must contain `manifest.yaml`. |TDD-4.5|
  - **Schema:** |TDD-4.6|
    - `name`: Unique identifier (string).
    - `version`: Semantic version (string).
    - `type`: "tool" | "routine".
    - `entry_point`: Relative path to python module definition (e.g., "src.plugin").

.. reconciliation_manifest:
   :section_id: tdd-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 40
   :tag_inventory: ["TDD-1", "TDD-1.1", "TDD-1.2", "TDD-1.3", "TDD-1.4", "TDD-1.5", "TDD-1.6", "TDD-1.7", "TDD-1.8", "TDD-1.9", "TDD-1.10", "TDD-1.11", "TDD-1.12", "TDD-1.13", "TDD-1.14", "TDD-1.15", "TDD-2", "TDD-2.1", "TDD-2.2", "TDD-2.3", "TDD-2.4", "TDD-2.5", "TDD-2.6", "TDD-2.7", "TDD-2.8", "TDD-2.9", "TDD-3", "TDD-3.1", "TDD-3.2", "TDD-3.3", "TDD-3.4", "TDD-3.5", "TDD-3.6", "TDD-4", "TDD-4.1", "TDD-4.2", "TDD-4.3", "TDD-4.4", "TDD-4.5", "TDD-4.6"]
   :pending_items: []

.. <<<END-TDD>>>


.. _isp-section:
.. <<<BEGIN-ISP>>>

================================================================================
ISP — Implementation Stubs (Prompts)
================================================================================

.. metadata:
   :file-id: isp-root
   :title: "Implementation Stubs"
   :version: "5.0"
   :date: "2025-12-17"
   :author: "Anthony Formosa"
   :roadmap_version: "5.0"
   :template_version: "2.0"
   :status: "Active"
   :llm-permissions: read-only
   :purpose: "Provide Executable Stubs for Code Generation"

Python Implementation Stubs
--------------------------------------------------------------------------------

.. _ISP-1:

Stub: Core Process |ISP-1| ← |TDD-1|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
**Implementation Requirements:**
- **Class Structure:** Inherit structure from `CoreProcess` blueprint. |ISP-1.1| ← |TDD-1.1| ← |TDD-1|
- **Socket:** Bind `ROUTER` using config from `ICD-1`. |ISP-1.2| ← |TDD-1.3|, |ICD-1| ← |TDD-1|
- **Orchestration:** Initialize `active_requests` dict and `PriorityQueue`. |ISP-1.3| ← |TDD-1.5| ← |TDD-1|
- **HSM:** Setup `transitions.Machine` with states from `FSD-2`. |ISP-1.4| ← |TDD-1.6|, |FSD-2.3| ← |FSD-2|

.. code-block:: python

   import zmq
   import yaml
   import queue
   import itertools
   import threading
   from transitions import Machine

   class CoreProcess:
       """
       Orchestrates IPC between services using ZeroMQ ROUTER pattern.
       Ref: |TDD-1|, |FSD-1|
       """
       def __init__(self, config_path: str):
           """
           Initialize ZMQ Context, Bind ROUTER.
           Init self.active_requests = {} (ID -> Identity, Ts, Cmd).
           Init self.queue = PriorityQueue(maxsize).
           Init self.counter = itertools.count().
           """
           pass

       def _start_receiver_thread(self) -> None:
           """
           Spawns a daemon thread running a ZMQ Poller.
           Parse: [client_identity, b'', metadata, payload...]
           Put (priority, next(counter), (client_identity, frames)) into queue.
           """
           pass

       def run(self) -> None:
           """
           Main Event Loop.
           1. Process self.queue (Priority).
           2. Check timeouts in self.active_requests (>5.0s).
           3. Drive HSM transitions (enter_processing, enter_error).
           """
           pass

.. _ISP-2:

Stub: Service Client |ISP-2| ← |TDD-2|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
**Implementation Requirements:**
- **Base Class:** Define `ServiceClient` for UI/Runtime/Audio. |ISP-2.1| ← |TDD-2.1| ← |TDD-2|
- **Connectivity:** Setup `DEALER` (Command) and `PUSH` (Log) sockets. |ISP-2.2| ← |TDD-2.4|, |TDD-2.5| ← |TDD-2|
- **Threading:** Implement `_receiver_thread` to populate internal `PriorityQueue`. |ISP-2.3| ← |TDD-2.6| ← |TDD-2|

.. code-block:: python

   class ServiceClient:
       """
       Standard client for Service processes.
       Maintains DEALER (Command) and PUSH (Log) sockets.
       Ref: |TDD-2|, |SAD-3|
       """
       def __init__(self, service_name: str, config_path: str):
           """
           Connects DEALER and PUSH sockets based on |ICD-1|.
           Sets PUSH socket to SNDHWM=1, LINGER=0 (Fire-and-Forget).
           Starts receiver thread.
           """
           pass

       def send_request(self, command: str, payload: dict, priority: int = 1) -> None:
           """
           Constructs metadata |ICD-3| and sends via DEALER.
           """
           pass

       def send_log(self, level: str, message: str, request_id: str = None) -> None:
           """
           Fire-and-forget log emission.
           Constructs frame: [Metadata(|ICD-3|), Message].
           Must swallow zmq.Again exceptions.
           """
           pass

.. _ISP-3:

Stub: LogServer Sink |ISP-3| ← |TDD-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
**Implementation Requirements:**
- **Socket:** Bind `PULL` socket for aggregation. |ISP-3.1| ← |TDD-3.3| ← |TDD-3|
- **Performance:** Use 1ms poll timeout for high throughput. |ISP-3.2| ← |TDD-3.4| ← |TDD-3|
- **Storage:** Configure `loguru` rotation/retention policies. |ISP-3.3| ← |TDD-3.6| ← |TDD-3|

.. code-block:: python

   from loguru import logger

   class LogServerSink:
       """
       Aggregates logs from all services via PULL socket.
       Ref: |TDD-3|, |FSD-6|
       """
       def __init__(self, config_path: str):
           """
           Bind PULL socket.
           Configure Loguru (Rotation: 50MB, Retention: 30 Days).
           """
           pass

       def run(self) -> None:
           """
           Tight Poll Loop (1ms).
           Parse [metadata, message] -> logger.log().
           """
           pass

.. _ISP-4:

Stub: Tool/Routine Interface |ISP-4| ← |TDD-4|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
**Implementation Requirements:**
- **Extensibility:** Define `AbstractTool` and `AbstractRoutine` using `ABC`. |ISP-4.1| ← |TDD-4.1| ← |TDD-4|
- **Contract:** Enforce `initialize`, `get_hsm_states`, and `handle_event`. |ISP-4.2| ← |TDD-4.2|, |TDD-4.3|, |TDD-4.4| ← |TDD-4|

.. code-block:: python

   from abc import ABC, abstractmethod
   from typing import List, Dict

   class AbstractTool(ABC):
       """
       Interface for modular functional assets.
       Ref: |TDD-4|, |FSD-3|
       """
       @abstractmethod
       def initialize(self, core_context) -> None:
           pass

       @abstractmethod
       def get_hsm_states(self) -> List[Dict]:
           """Return state definitions for dynamic compilation."""
           pass

       @abstractmethod
       def handle_event(self, event_data: Dict) -> str:
           """Process logic and return next trigger."""
           pass

.. _ISP-5:

Stub: Audio Worker Loop |ISP-5| ← |FSD-4|, |NFR-3|
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
**Implementation Requirements:**
- **Logic:** Implement Wake Word -> VAD -> STT pipeline. |ISP-5.1| ← |FSD-4|
- **Constraint:** Check Core State (`idle`) before sending Wake Word events. |ISP-5.2| ← |FSD-4.2| ← |FSD-4|

.. code-block:: python

   def audio_worker_loop(client: ServiceClient):
       """
       Real-time audio processing loop.
       Ref: |FSD-4|, |NFR-3|
       """
       # Setup pvporcupine (Wake Word) and webrtcvad (VAD)
       
       while True:
           # 1. Read Audio Chunk
           # 2. Denoise
           # 3. Check Wake Word -> client.send_request("WAKE_WORD") IF Core is IDLE
           # 4. Check VAD -> Buffer for STT
           # 5. Handle inbound IPC messages (client.poll_queue)
           pass

.. reconciliation_manifest:
   :section_id: isp-root
   :integrity_status: "CLEAN"
   :timestamp: "2025-12-17"
   :tag_count: 19
   :tag_inventory: ["ISP-1", "ISP-1.1", "ISP-1.2", "ISP-1.3", "ISP-1.4", "ISP-2", "ISP-2.1", "ISP-2.2", "ISP-2.3", "ISP-3", "ISP-3.1", "ISP-3.2", "ISP-3.3", "ISP-4", "ISP-4.1", "ISP-4.2", "ISP-5", "ISP-5.1", "ISP-5.2"]
   :pending_items: []

.. <<<END-ISP>>>


.. <<<END-DDR>>>