
## 5. Vertical Abstraction & Specification Protocols

### 5.1 Upward Abstraction (Child → Parent)

When an orphaned specification exists without a parent requirement, synthesize the parent by extracting the **strategic intent** or **constraint boundary**.

#### Protocol Steps

1.  **Identify the Essence:** Strip implementation details, preserve the "why" or "what limit"
2.  **Elevate Abstraction:** Transform technical specifics into business/constraint language
3.  **Validate Scope:** Ensure parent tier encompasses multiple potential child implementations
4.  **Check Redundancy:** Verify parent doesn't duplicate existing tags

#### Example 1: TDD → SAD Abstraction

**Orphaned Child (TDD):**
> **Embedded Example Type:** reStructuredText TDD directive
~~~rst
.. tdd:: Concurrency: Spawns receiver thread to poll ROUTER socket.
   :id: TDD-1.7
~~~

**Abstraction Process:**

-   **Technical Detail:** "Spawns receiver thread"
-   **Architectural Pattern:** "Non-blocking I/O via background polling"
-   **Constraint Context:** Must avoid blocking main loop (traces to NFR-5.1)

**Synthesized Parent (SAD):**
> **Embedded Example Type:** reStructuredText SAD directive
~~~rst
.. sad:: Receiver Threads: Each process uses dedicated thread to poll ZMQ sockets and push to internal PriorityQueue.
   :id: SAD-4.1
   :links: NFR-5.1
~~~

**Validation:**

-   ✅ Covers multiple implementations (Core, UI, Runtime, Audio)
-   ✅ Describes architectural mechanism, not specific code
-   ✅ Cites constraint that mandates the pattern

#### Example 2: FSD → BRD Abstraction

**Orphaned Child (FSD):**
> **Embedded Example Type:** reStructuredText FSD directive
~~~rst
.. fsd:: Wake Word: Always-on detection using pvporcupine.
   :id: FSD-4.1
~~~

**Abstraction Process:**

-   **Functional Spec:** "Wake word detection"
-   **User Value:** "Hands-free voice activation"
-   **Business Objective:** "Enable natural voice interaction"

**Synthesized Parent (BRD):**
> **Embedded Example Type:** reStructuredText BRD directive
~~~rst
.. brd:: Voice Activation: Enable hands-free voice interaction for accessibility and user convenience.
   :id: BRD-5.7
~~~

**Validation:**

-   ✅ Technology-agnostic (doesn't specify pvporcupine)
-   ✅ Focuses on business value, not implementation
-   ✅ Supports multiple potential wake word technologies

#### Example 3: ICD → SAD Abstraction

**Orphaned Child (ICD):**
> **Embedded Example Type:** reStructuredText ICD directive
~~~rst
.. icd:: Frame Structure: Outbound
   :id: ICD-2.2

   .. code-block:: json

      ["metadata_json", "payload_bytes..."]

~~~

**Abstraction Process:**

-   **Protocol Detail:** "Metadata + payload frame structure"
-   **Integration Pattern:** "Request-response messaging"
-   **Architectural Choice:** "ZeroMQ DEALER socket pattern"

**Synthesized Parent (SAD):**
> **Embedded Example Type:** reStructuredText SAD directive
~~~rst
.. sad:: Pattern: ZeroMQ ROUTER (Core) ↔ DEALER (Service) for bidirectional request-response messaging.
   :id: SAD-3.2
   :links: FSD-1.1

~~~

**Validation:**

-   ✅ Defines the architectural pattern enabling the protocol
-   ✅ Justifies why frame structure exists (DEALER requirements)
-   ✅ Traces to functional requirement (Core routing)

### 5.2 Downward Specification (Parent → Child)

When a high-level requirement lacks implementation details, decompose it by extracting **concrete mechanisms** or **technical constraints**.

#### Protocol Steps

1.  **Identify Implementation Vectors:** What specific technologies/patterns enable this?
2.  **Extract Measurables:** Convert qualitative goals to quantitative specs
3.  **Partition by Concern:** Separate architecture, data, and code aspects
4.  **Maintain Traceability:** Cite parent tag in all derived children

#### Example 1: BRD → NFR Specification

**Orphaned Parent (BRD):**
> **Embedded Example Type:** reStructuredText BRD directive
~~~rst
.. brd:: Latency Targets
   :id: BRD-8.1

   Sub-250ms IPC dispatch; <1s LLM response.

~~~

**Specification Process:**

-   **Implied Constraints:** System must use non-blocking I/O
-   **Hardware Requirements:** Need fast CPU for IPC, GPU for LLM
-   **Measurable Targets:** Break down into component-level latencies

**Synthesized Children (NFR):**
> **Embedded Example Type:** reStructuredText NFR directive
~~~rst
.. nfr:: Latency & Throughput
   :id: NFR-4
   :links: BRD-8.1

.. nfr:: IPC Dispatch: Sub-millisecond (<1ms) for metadata-only.
   :id: NFR-4.1
   :links: NFR-4

.. nfr:: Round Trip: <5ms metadata; <20ms for 1MB payload.
   :id: NFR-4.2
   :links: NFR-4

.. nfr:: LLM Inference: <1s average response time.
   :id: NFR-4.3
   :links: NFR-4

~~~

**Validation:**

-   ✅ All children trace to parent
-   ✅ Quantifies ambiguous "sub-250ms" into specific component budgets
-   ✅ Adds granularity (metadata vs payload latency)

#### Example 2: NFR → SAD Specification

**Orphaned Parent (NFR):**

~~~rst
.. nfr:: No process shall block waiting for another during IPC.
   :id: NFR-5.1

~~~

**Specification Process:**

-   **Architectural Implication:** Need asynchronous messaging
-   **Pattern Selection:** ZeroMQ with dedicated receiver threads
-   **Data Structure:** Internal queues to decouple I/O from logic

**Synthesized Children (SAD):**
> **Embedded Example Type:** reStructuredText SAD directive
~~~rst
.. sad:: Concurrency Model
   :id: SAD-4
   :links: NFR-5.1

.. sad:: Receiver Threads: Dedicated thread polls ZMQ sockets.
   :id: SAD-4.1
   :links: SAD-4

.. sad:: Main Loop: Processes PriorityQueue (non-blocking).
   :id: SAD-4.2
   :links: SAD-4

.. sad:: Queueing: Must use queue.PriorityQueue.
   :id: SAD-4.3
   :links: SAD-4

~~~

**Validation:**

-   ✅ Translates constraint into concrete architectural decisions
-   ✅ Specifies mechanism that enforces parent requirement
-   ✅ Enables multiple implementations (Core, Services)

#### Example 3: FSD → ICD Specification

**Orphaned Parent (FSD):**

~~~rst
.. fsd:: Correlation: All logs must include request_id.
   :id: FSD-6.3
~~~

**Specification Process:**

-   **Data Requirement:** request_id field in log metadata
-   **Format Constraint:** Must be UUID v4 format
-   **Protocol Rule:** Must be propagated in every IPC frame

**Synthesized Children (ICD):**
> **Embedded Example Type:** reStructuredText ICD directive
~~~rst
.. icd:: Metadata Schema (JSON)
   :id: ICD-3
   :links: FSD-6.3

   .. code-block:: json

      {
        "request_id": "uuid-v4-string"
      }

.. icd:: Log Frame Structure
   :id: ICD-2.5
   :links: FSD-6.3

   [metadata_json, message_string] (Metadata MUST include request_id)

~~~

**Validation:**

-   ✅ Defines exact data structure to implement feature
-   ✅ Specifies format constraint (UUID v4)
-   ✅ Covers all message types (IPC and logging)

### 5.3 Lateral Expansion (Sibling Generation)

When a tag exists in isolation but implies peer requirements, generate siblings by identifying **parallel concerns** at the same abstraction level.

#### Example: Generating FSD Siblings

**Existing Singleton:**
> **Embedded Example Type:** reStructuredText FSD directive
~~~rst
.. fsd:: LogServer Fault: Senders continue, drop logs silently.
   :id: FSD-7.1

~~~

**Implied Parallel Concerns:**

-   What about UI/Runtime/Audio faults?
-   What about Core faults?
-   What about timeout scenarios?

**Generated Siblings:**
> **Embedded Example Type:** reStructuredText FSD directive
~~~rst
.. fsd:: Error Handling Strategy
   :id: FSD-7
   :links: BRD-2, NFR-5

.. fsd:: LogServer Fault: Senders continue, drop logs silently.
   :id: FSD-7.1
   :links: FSD-7

.. fsd:: Service Fault: Core detects, marks unavailable, error state.
   :id: FSD-7.2
   :links: FSD-7

.. fsd:: Timeout: Core detects non-response >5s, triggers error.
   :id: FSD-7.3
   :links: FSD-7

.. fsd:: Core Fault: Services disconnect, attempt reconnect.
   :id: FSD-7.4
   :links: FSD-7

~~~

**Validation:**

-   ✅ All siblings address fault tolerance at same abstraction (behavior)
-   ✅ Comprehensive coverage of failure modes
-   ✅ Uniform citation of parent requirements

----------
