
## 21. Documentation Anti-Pattern Deep Dive

### 21.1 The "Implementation Leak" Anti-Pattern

**Problem:** Technical implementation details appearing in business/feature tiers.

**Example (WRONG):**

~~~rst
.. fsd:: implementation_detail
   :id: FSD-X

   The system uses zmq.ROUTER socket bound to tcp://127.0.0.1:5555 to receive user requests from the PySide6 QApplication main thread.
~~~

**Why Wrong:**

-   **FSD Violation:** Mentions specific technologies (ZeroMQ, PySide6)
-   **Mixed Abstraction:** Combines behavior (receive requests) with implementation (socket binding)
-   **Maintenance Burden:** Technology changes require FSD updates (should be isolated to SAD/TDD)

**Correct Decomposition:**

~~~rst
.. fsd:: Request Routing
   :id: FSD-1.1
   :links: BRD-5

   Core routes request-response messages between services.

.. sad:: Communication Pattern
   :id: SAD-3.2
   :links: FSD-1.1, NFR-5.1

   Pattern: ZeroMQ ROUTER (Core) ↔ DEALER (Service).

.. icd:: core_routing_config
   :id: ICD-1
   :links: SAD-3.2

   .. code-block:: yaml

      core:
        router_bind: "tcp://127.0.0.1:5555"

.. tdd:: Router Socket Binding
   :id: TDD-1.3
   :links: ICD-1

   Socket: Bind ROUTER to core.router_bind (from config).

.. isp:: Core Init Stub
   :id: ISP-1
   :links: TDD-1.3

   .. code-block:: python

      def __init__(self, config_path: str):
          self.router = self.context.socket(zmq.ROUTER)
          self.router.bind(self.config['router_bind'])
~~~

----------

### 21.2 The "Orphaned Rationale" Anti-Pattern

**Problem:** Design decisions without traceability to requirements.

**Example (WRONG):**

~~~rst
.. sad:: Message Ordering
   :id: SAD-X

   Use priority queues for message ordering.
~~~

**Why Wrong:**

-   **No Justification:** Doesn't explain WHY priority matters
-   **No Traceability:** Missing citation to parent requirement
-   **Incomplete:** Doesn't specify priority levels or ordering rules

**Correct Pattern:**

~~~rst
.. nfr:: Non-Blocking Execution
   :id: NFR-5.1
   :links: BRD-3.4

   No process shall block waiting for another.

.. sad:: Queueing Strategy
   :id: SAD-4.3
   :links: NFR-5.1

   RATIONALE: Priority queues prevent control messages (shutdown, error) from being blocked behind long-running data messages, enforcing the non-blocking constraint.

.. sad:: Priority Queue Type
   :id: SAD-4.4
   :links: SAD-4.3

   Must use queue.PriorityQueue.

.. sad:: Message Structure
   :id: SAD-4.5
   :links: SAD-4.3

   Structure: (priority, counter, message).

.. sad:: High Priority Levels
   :id: SAD-4.8
   :links: SAD-4.3

   High Priority (0): shutdown, error_notification.

.. sad:: Normal Priority Levels
   :id: SAD-4.9
   :links: SAD-4.3

   Normal Priority (1): Inference requests.
~~~

----------

### 21.3 The "Premature Optimization" Anti-Pattern

**Problem:** Performance targets without business justification.

**Example (WRONG):**

~~~rst
.. nfr:: overhead_optimization
   :id: NFR-X

   All IPC messages must complete in <100 microseconds.
~~~

**Why Wrong:**

-   **No Business Context:** Why does 100μs matter to users/business?
-   **Over-Specification:** May be orders of magnitude tighter than needed
-   **Implementation Constraint:** Forces expensive optimizations without ROI

**Correct Pattern:**

~~~rst
.. brd:: Real-Time Conversational Experience
   :id: BRD-12

   Target: <5% session abandonment due to lag (current: 18%).

.. nfr:: End-to-End Latency
   :id: NFR-11.1
   :links: BRD-12

   Value: ≤3s (voice-to-response, 95th percentile).
   RATIONALE: User research shows 3s perceived as "instant", >5s causes frustration and abandonment.

.. nfr:: Latency Budget Breakdown
   :id: NFR-11.2
   :links: NFR-11.1

   - STT: 500ms (allows buffering for VAD endpoint detection)
   - LLM: 1500ms (achievable with INT4 quantization on RTX 3080)
   - TTS: 800ms (streaming synthesis, first audio chunk <200ms)
   - IPC: 200ms (total overhead across all routing)

   RATIONALE: Budget allocates majority to inference tasks (80%), minimizes overhead (7%), provides margin for 95th percentile variance.

.. nfr:: IPC Round Trip
   :id: NFR-4.2
   :links: NFR-11.2

   Value: <20ms for 1MB payload.
   RATIONALE: 200ms total IPC budget / 10 average messages per request = 20ms each.
~~~

----------
