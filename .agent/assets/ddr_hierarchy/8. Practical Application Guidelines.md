
## 8. Practical Application Guidelines

### 8.1 New Feature Workflow

**Scenario:** Add "Voice Sentiment Analysis" feature

**Step 1: BRD (Business Justification)**

```
|BRD-10|: "Sentiment-Aware Responses"
Enable context-aware emotional intelligence to improve user satisfaction
and engagement metrics (target: 25% increase in session duration).

```

**Step 2: NFR (Constraints)**

```
|NFR-9| ← |BRD-10|: "Sentiment Analysis Constraints"
  |NFR-9.1|: CPU-based inference (max 50ms latency per audio chunk).
  |NFR-9.2|: Model size <100MB (fits in system RAM).
  |NFR-9.3|: Accuracy: F1 score ≥ 0.75 on IEMOCAP dataset.

```

**Step 3: FSD (Behavior)**

```
|FSD-10| ← |NFR-9|: "Sentiment Detection Pipeline"
  |FSD-10.1|: Audio Service extracts prosodic features (pitch, energy).
  |FSD-10.2|: Sentiment classifier runs asynchronously (non-blocking).
  |FSD-10.3|: Results tagged to request_id, sent to Core.
  |FSD-10.4|: LLM Service receives sentiment context in prompt metadata.

```

**Step 4: SAD (Architecture)**

```
|SAD-7| ← |FSD-10.2|: "Asynchronous Sentiment Processing"
  |SAD-7.1|: Pattern: Fire-and-forget PUSH (Audio) → PULL (Core).
  |SAD-7.2|: No blocking on sentiment result (best-effort enrichment).

```

**Step 5: ICD (Contracts)**

```json
|ICD-6| ← |SAD-7.1|: "Sentiment Metadata Schema"
{
  "request_id": "uuid-v4",
  "sentiment": {
    "label": "neutral" | "positive" | "negative" | "unknown",
    "confidence": 0.0-1.0,
    "valence": -1.0 to +1.0,
    "arousal": 0.0 to 1.0
  }
}

```

**Step 6: TDD (Component Design)**

```
|TDD-5| ← |ICD-6|: "Component: SentimentClassifier"
  |TDD-5.1|: Class: SentimentClassifier (runs in Audio Process).
  |TDD-5.2|: Dependencies: librosa, numpy, onnxruntime (CPU).
  |TDD-5.3|: Method: analyze(audio_chunk: np.ndarray) -> Dict.
  |TDD-5.4|: Internal: ONNX model loaded on init (<100MB per NFR-9.2).

```

**Step 7: ISP (Code Stub)**

```python
|ISP-6| ← |TDD-5|:

import numpy as np
import onnxruntime as ort

class SentimentClassifier:
    """
    CPU-based sentiment analysis from audio prosody.

    Implements
    ----------
    |TDD-5|, |FSD-10|

    Constraints
    -----------
    |NFR-9.1|: Max 50ms latency
    |NFR-9.2|: Model <100MB
    """

    def __init__(self, model_path: str):
        """
        Load ONNX model for CPU inference.

        Parameters
        ----------
        model_path : str
            Path to sentiment.onnx (<100MB per |NFR-9.2|)

        References
        ----------
        |TDD-5.4|
        """
        pass

    def analyze(self, audio_chunk: np.ndarray) -> dict:
        """
        Extract sentiment from audio prosody.

        Parameters
        ----------
        audio_chunk : np.ndarray
            PCM audio (16kHz, mono)

        Returns
        -------
        dict
            Sentiment metadata per |ICD-6| schema

        References
        ----------
        |FSD-10.1|, |NFR-9.1|
        """
        pass

```

### 8.2 Refactoring Existing Documentation

**Scenario:** Discovered `|FSD-4.4|` incorrectly specifies GPU-based VAD, violating `|NFR-1.1|` (CPU-only Audio)

**Step 1: Identify Conflict**

```
|NFR-1.1|: "CPU: AMD Ryzen 9 5900X (Audio/Core must run here)."
|FSD-4.4|: "VAD (Stage 2): Silero via ONNX Runtime GPU."
           ^^^^^^^^^^^^ CONFLICT: Audio process can't use GPU

```

**Step 2: Mark Dirty**

```yaml
.. reconciliation_manifest (FSD):
   :integrity_status: "DIRTY"
   :pending_items:
     - target_tag: "FSD-4.4"
       source_trigger: "NFR-1.1"
       issue_type: "CONSTRAINT_VIOLATION"
       description: "FSD-4.4 specifies GPU inference but NFR-1.1 restricts
                     Audio Process to CPU only."

```

**Step 3: Resolve Conflict**

**Option A: Move to Runtime Process (Architecture Change)**

```
REVISED |FSD-4.4| ← |NFR-1.2|: "VAD (Stage 2): Silero via ONNX Runtime
GPU in Runtime Process. Audio sends raw buffer to Core for routing."

NEW |SAD-8|: "Audio-to-Runtime VAD Pipeline"
  |SAD-8.1|: Audio (webrtcvad) → Core → Runtime (Silero) → Core.
  |SAD-8.2|: Adds 10-20ms IPC overhead (acceptable per NFR-4.2).

```

**Option B: Use CPU-based Silero (Simpler)**

```
REVISED |FSD-4.4| ← |NFR-1.1|, |BRD-5.2|: "VAD (Stage 2): Silero via
ONNX Runtime CPU. Runs locally in Audio Process."

UPDATE |NFR-9.4|: "Silero VAD CPU Latency: <30ms per chunk."

```

**Step 4: Cascade Updates**

```
UPDATE |TDD-2.X|: "Audio Process: ONNX Runtime CPU session for Silero."
UPDATE |ICD-X|: Remove GPU memory allocation from audio config.
CLEAN reconciliation_manifest.

```

----------
