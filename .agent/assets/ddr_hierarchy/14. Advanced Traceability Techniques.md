
## 14. Advanced Traceability Techniques

### 14.1 Impact Analysis Queries

When modifying a tag, determine downstream effects:

**Query Template:**

~~~sql
-- Impact Analysis Query Template
SELECT tag_id, content, type
FROM documentation
WHERE parent_citations LIKE '%TARGET_TAG%'
ORDER BY tier_depth DESC;
~~~

**Example: Changing NFR-4.3**

~~~rst
**Example: Changing NFR-4.3**

INPUT:
.. nfr:: LLM Inference: <1s
   :id: NFR-4.3
   → CHANGING TO <2s

IMPACT ANALYSIS:
┌──────────┬────────────────────────────────────┬──────┐
│ ID       │ Content Summary                    │ Tier │ Remarks                     │
├──────────┼────────────────────────────────────┼──────┼─────────────────────────────┤
│ FSD-12.3 │ TTS begins after first sentence    │ fsd  │ :links: May need adjustment │
│ SAD-10.4 │ Back-pressure queue size           │ sad  │ OK                          │
│ ICD-8    │ Streaming token schema             │ icd  │ OK                          │
│ TDD-7.3  │ generate_stream() method           │ tdd  │ OK                          │
│ ISP-8    │ Performance note in docstring      │ isp  │ UPDATE REQUIRED             │
└──────────┴────────────────────────────────────┴──────┴─────────────────────────────┘

ACTION ITEMS:
1. Update ISP-8 docstring: "First token within 200ms"
2. Review FSD-12.3: Verify 2s budget
3. Mark reconciliation_manifest as DIRTY
~~~

### 14.2 Traceability Graphs

Visualize tag relationships for complex features:

~~~mermaid
graph TD
    BRD13[".. brd:: Contextual Memory<br/>:id: BRD-13"]
    NFR12[".. nfr:: Memory Constraints<br/>:id: NFR-12"]
    FSD14[".. fsd:: Indexing Behavior<br/>:id: FSD-14"]
    SAD12[".. sad:: Memory Architecture<br/>:id: SAD-12"]
    ICD9[".. icd:: Index Schema<br/>:id: ICD-9"]
    ICD10[".. icd:: Search Schema<br/>:id: ICD-10"]
    TDD8[".. tdd:: MemoryService<br/>:id: TDD-8"]
    ISP9[".. isp:: Service Stub<br/>:id: ISP-9"]

    BRD13 --> NFR12
    NFR12 --> FSD14
    FSD14 --> SAD12
    SAD12 --> ICD9
    SAD12 --> ICD10
    ICD9 --> TDD8
    ICD10 --> TDD8
    TDD8 --> ISP9

    style BRD13 fill:#e1f5ff
    style NFR12 fill:#fff3e0
    style FSD14 fill:#f3e5f5
    style SAD12 fill:#e8f5e9
    style ICD9 fill:#fce4ec
    style ICD10 fill:#fce4ec
    style TDD8 fill:#fff9c4
    style ISP9 fill:#f1f8e9
~~~

### 14.3 Orphan Detection Algorithms

**Upward Orphan (Missing Parent):**

~~~python
# Orphan Detection Algorithms (Updated for NEW RST Directives)

def detect_upward_orphans(documentation: dict) -> List[str]:
    """
    Find tags that cite non-existent parents.

    Returns
    -------
    List[str]
        Tag IDs with broken citations
    """
    all_tag_ids = set(documentation.keys())
    orphans = []

    for tag_id, doc_obj in documentation.items():
        # doc_obj contains parsed :links: list
        for parent_id in doc_obj.links:
            if parent_id not in all_tag_ids:
                orphans.append(f"{tag_id} → :links: {parent_id} (MISSING)")

    return orphans

def detect_downward_orphans(documentation: dict, tier: str) -> List[str]:
    """
    Find tier-N tags that have no tier-(N+1) children.
    Indicates incomplete specification.
    """
    child_tier_map = {"brd": "nfr", "nfr": "fsd", "fsd": "sad",
                      "sad": "icd", "icd": "tdd", "tdd": "isp"}

    if tier.lower() not in child_tier_map:
        return []

    child_tier = child_tier_map[tier.lower()]
    tier_tags = [t for t in documentation if t.startswith(tier.upper())]
    child_citations = set()

    for child_tag, doc_obj in documentation.items():
        if child_tag.startswith(child_tier.upper()):
            child_citations.update(doc_obj.links)

    return [t for t in tier_tags if t not in child_citations]
~~~

**Example Output:**

~~~rst
UPWARD ORPHANS (Broken Citations):
- FSD-14.2 → :links: NFR-999 (MISSING) → CREATE NFR-999 or FIX LINK

DOWNWARD ORPHANS (Incomplete Specs):
- SAD-7 (no icd children) → CREATE ICD schema for sentiment data
- FSD-11.3 (no sad children) → SPECIFY architecture for model validation
~~~

----------
