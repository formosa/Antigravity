
## 9. Common Pitfalls & Anti-Patterns

### 9.1 Anti-Pattern: Technology in BRD

**WRONG:**

~~~rst
.. brd:: IPC Technology Mandate
   :id: BRD-X (WRONG)

   Use ZeroMQ for inter-process communication.
~~~

**Why Wrong:** BRD should be technology-agnostic. "ZeroMQ" is an implementation detail.

**CORRECT:**

~~~rst
.. brd:: Offline, multi-process framework with low-latency IPC.
   :id: BRD-5.1

.. nfr:: No process blocking on IPC (sub-ms dispatch).
   :id: NFR-5.1
   :links: BRD-5.1

.. sad:: Technology: ZeroMQ ROUTER-DEALER pattern.
   :id: SAD-3.2
   :links: NFR-5.1
~~~

### 9.2 Anti-Pattern: Business Logic in TDD

**WRONG:**

~~~rst
.. tdd:: Wake Word Handler (WRONG)
   :id: TDD-X

   .. code-block:: python

      def handle_wake_word(self):
          """Only send WAKE_WORD if Core is idle."""
          if self.core_state == "idle":
              self.send_request("WAKE_WORD")
~~~

**Why Wrong:** TDD defines structure, not logic. Business rules belong in FSD.

**CORRECT:**

~~~rst
.. fsd:: Must only send WAKE_WORD_DETECTED if Core is in idle state.
   :id: FSD-4.2

.. tdd:: Method: check_core_state() -> bool
   :id: TDD-X
   :links: FSD-4.2

.. isp:: Logic Implementation stub
   :id: ISP-X
   :links: TDD-X
~~~

### 9.3 Anti-Pattern: Schema in SAD

**WRONG:**

~~~rst
.. sad:: Metadata Format (WRONG)
   :id: SAD-X

   .. code-block:: json

      {"command": "string", "request_id": "uuid"}
~~~

**Why Wrong:** SAD defines patterns, not data shapes. Schemas belong in ICD.

**CORRECT:**

~~~rst
.. sad:: Requirement: Core maintains routing table (identity → socket).
   :id: SAD-3.4

.. icd:: Request ID Schema
   :id: ICD-3
   :links: SAD-3.4
~~~

### 9.4 Anti-Pattern: Implementation in ISP

**WRONG:**

~~~rst
.. isp:: Implementation Code (WRONG)
   :id: ISP-X

   .. code-block:: python

      def send_log(self, level, msg):
          meta = json.dumps({"level": level, "ts": time.time()})
          self.push.send_multipart([meta.encode(), msg.encode()])
~~~

**Why Wrong:** ISP provides stubs, not complete implementations.

**CORRECT:**

~~~python
# |ISP-X|: "Log Emission Stub"

def send_log(self, level: str, msg: str) -> None:
    """
    Fire-and-forget log emission.

    Implementation Steps
    --------------------
    1. Construct metadata per |ICD-3|
    2. Serialize to JSON, encode UTF-8
    3. Call self.push.send_multipart([meta, msg])
    4. Wrap in try-except for zmq.Again

    References
    ----------
    |TDD-2.5|, |SAD-3.8|
    """
    pass
~~~

### 9.5 Anti-Pattern: Circular Citations

**WRONG:**

~~~rst
.. nfr:: No blocking on IPC. (WRONG CITATION)
   :id: NFR-5.1
   :links: SAD-4.1

.. sad:: Use receiver threads. (CIRCULAR)
   :id: SAD-4.1
   :links: NFR-5.1
~~~

**Why Wrong:** Creates circular dependency. Parent → Child flow must be strictly downward.

**CORRECT:**

~~~rst
.. nfr:: No blocking on IPC.
   :id: NFR-5.1
   :links: BRD-3.4

.. sad:: Pattern: Receiver threads + queues.
   :id: SAD-4.1
   :links: NFR-5.1
~~~

----------
