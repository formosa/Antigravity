
## 9. Common Pitfalls & Anti-Patterns

### 9.1 Anti-Pattern: Technology in BRD

**WRONG:**

```
|BRD-X|: "Use ZeroMQ for inter-process communication."

```

**Why Wrong:** BRD should be technology-agnostic. "ZeroMQ" is an implementation detail.

**CORRECT:**

```
|BRD-5.1|: "Offline, multi-process framework with low-latency IPC."
|NFR-5.1| ← |BRD-5.1|: "No process blocking on IPC (sub-ms dispatch)."
|SAD-3.2| ← |NFR-5.1|: "Technology: ZeroMQ ROUTER-DEALER pattern."

```

### 9.2 Anti-Pattern: Business Logic in TDD

**WRONG:**

```python
|TDD-X|:
def handle_wake_word(self):
    """Only send WAKE_WORD if Core is idle."""
    if self.core_state == "idle":
        self.send_request("WAKE_WORD")

```

**Why Wrong:** TDD defines structure, not logic. Business rules belong in FSD.

**CORRECT:**

```
|FSD-4.2|: "Must only send WAKE_WORD_DETECTED if Core is in idle state."
|TDD-X| ← |FSD-4.2|: "Method: check_core_state() -> bool"
|ISP-X| ← |TDD-X|: [Code stub with logic implementation]

```

### 9.3 Anti-Pattern: Schema in SAD

**WRONG:**

```json
|SAD-X|: "Metadata Format"
{"command": "string", "request_id": "uuid"}

```

**Why Wrong:** SAD defines patterns, not data shapes. Schemas belong in ICD.

**CORRECT:**

```
|SAD-3.4|: "Requirement: Core maintains routing table (identity → socket)."
|ICD-3| ← |SAD-3.4|: [JSON schema with request_id field]

```

### 9.4 Anti-Pattern: Implementation in ISP

**WRONG:**

```python
|ISP-X|:
def send_log(self, level, msg):
    meta = json.dumps({"level": level, "ts": time.time()})
    self.push.send_multipart([meta.encode(), msg.encode()])

```

**Why Wrong:** ISP provides stubs, not complete implementations.

**CORRECT:**

```python
|ISP-X|:
def send_log(self, level: str, msg: str) -> None:
    """
    Fire-and-forget log emission.

    Implementation Steps
    --------------------
    1. Construct metadata per |ICD-3|
    2. Serialize to JSON, encode UTF-8
    3. Call self.push.send_multipart([meta, msg])
    4. Wrap in try-except for zmq.Again

    References
    ----------
    |TDD-2.5|, |SAD-3.8|
    """
    pass

```

### 9.5 Anti-Pattern: Circular Citations

**WRONG:**

```
|NFR-5.1| ← |SAD-4.1|: "No blocking on IPC."
|SAD-4.1| ← |NFR-5.1|: "Use receiver threads."

```

**Why Wrong:** Creates circular dependency. Parent → Child flow must be strictly downward.

**CORRECT:**

```
|NFR-5.1| ← |BRD-3.4|: "No blocking on IPC."
|SAD-4.1| ← |NFR-5.1|: "Pattern: Receiver threads + queues."

```

----------
