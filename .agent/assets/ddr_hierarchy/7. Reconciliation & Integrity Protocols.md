
## 7. Reconciliation & Integrity Protocols

### 7.1 The Manifest System

Each document section includes a `reconciliation_manifest` tracking:
> **Embedded Example Type:** reStructuredText reconciliation_manifest directive
~~~rst
.. reconciliation_manifest:
   :section_id: "fsd-root"
   :integrity_status: "CLEAN" | "DIRTY"
   :timestamp: "2025-12-17"
   :tag_count: 46
   :tag_inventory: ["FSD-1", "FSD-1.1", ..., "FSD-9.4"]
   :pending_items: []

~~~

### 7.2 Dirty Flag Triggers

**Automatic DIRTY Status When:**

1.  **Tag Modified:** Any edit to a tag's content
2.  **Tag Deleted:** Removal of a tag and its downstream citations
3.  **Tag Added:** New tag without parent validation
4.  **Child Orphaned:** Parent deleted but children remain
5.  **Inventory Mismatch:** Tag count ≠ actual tags in section

### 7.3 Pending Items Schema

When inconsistencies detected, append to `pending_items`:
> **Embedded Example Type:** reStructuredText reconciliation_pending_item directive
~~~rst
.. reconciliation_pending_item:: FSD-4.4
   :source: NFR-1.1
   :type: CONSTRAINT_VIOLATION

   .. code-block:: json

      {
        "description": "NFR-1.1 now mandates CPU-only for Audio, but FSD-4.4 specifies GPU-based Silero VAD. Resolve conflict."
      }

~~~

**Issue Types:**

-   `CONSTRAINT_VIOLATION`: Child violates modified parent constraint
-   `MISSING_PARENT`: Orphaned child needs upstream justification
-   `BROKEN_CITATION`: Tagged parent doesn't exist
-   `DUPLICATE_SPEC`: Multiple children specify same implementation

### 7.4 Reconciliation Workflow
> **Embedded Example Type:** reStructuredText documentation
~~~rst
**Workflow:**

1. Detect Change → Set integrity_status = "DIRTY"
2. Analyze Impact → Scan all downstream citations
3. Generate Pending Items → Document conflicts
4. Human Review → Architect resolves conflicts
5. Update Tags → Modify content, citations
6. Validate Inventory → Recount tags, update manifest
7. Clear Dirty Flag → integrity_status = "CLEAN"

~~~

#### Example: Reconciliation After NFR Change

**Initial State:**
> **Embedded Example Type:** reStructuredText NFR directive
~~~rst
.. nfr:: Memory (Core Queue): 1000 cap, ~10-50 MB.
   :id: NFR-3.3
   :links: BRD-6.1

.. icd:: core.queue_maxsize: 1000
   :id: ICD-1

.. tdd:: Queue Initialization
   :id: TDD-1

   self.queue = PriorityQueue(maxsize=config['queue_maxsize'])

~~~

**Change Event:**
> **Embedded Example Type:** reStructuredText NFR directive
~~~rst
.. nfr:: Memory (Core Queue): 2000 cap, ~20-100 MB.
   :id: NFR-3.3 (MODIFIED)

~~~

**Manifest Update:**
> **Embedded Example Type:** reStructuredText reconciliation_manifest directive
~~~rst
.. reconciliation_manifest:
   :integrity_status: "DIRTY"
   :pending_items:
     - target_tag: "ICD-1"
       source_trigger: "NFR-3.3"
       issue_type: "CONSTRAINT_VIOLATION"
       description: "Config schema specifies 1000, NFR now requires 2000."

~~~

**Resolution:**
> **Embedded Example Type:** reStructuredText ICD directive
~~~rst
.. icd:: local_bind
   :id: ICD-1

   .. code-block:: yaml

      core:
        queue_maxsize: 2000  # Updated per NFR-3.3 revision

.. reconciliation_manifest:
   :integrity_status: "CLEAN"
   :pending_items: []

~~~

----------
