
## 7. Reconciliation & Integrity Protocols

### 7.1 The Manifest System

Each document section includes a `reconciliation_manifest` tracking:

```yaml
.. reconciliation_manifest:
   :section_id: "fsd-root"
   :integrity_status: "CLEAN" | "DIRTY"
   :timestamp: "2025-12-17"
   :tag_count: 46
   :tag_inventory: ["FSD-1", "FSD-1.1", ..., "FSD-9.4"]
   :pending_items: []

```

### 7.2 Dirty Flag Triggers

**Automatic DIRTY Status When:**

1.  **Tag Modified:** Any edit to a tag's content
2.  **Tag Deleted:** Removal of a tag and its downstream citations
3.  **Tag Added:** New tag without parent validation
4.  **Child Orphaned:** Parent deleted but children remain
5.  **Inventory Mismatch:** Tag count ≠ actual tags in section

### 7.3 Pending Items Schema

When inconsistencies detected, append to `pending_items`:

```json
{
  "target_tag": "FSD-4.4",
  "source_trigger": "NFR-1.1",
  "issue_type": "CONSTRAINT_VIOLATION",
  "description": "NFR-1.1 now mandates CPU-only for Audio, but FSD-4.4
                  specifies GPU-based Silero VAD. Resolve conflict."
}

```

**Issue Types:**

-   `CONSTRAINT_VIOLATION`: Child violates modified parent constraint
-   `MISSING_PARENT`: Orphaned child needs upstream justification
-   `BROKEN_CITATION`: Tagged parent doesn't exist
-   `DUPLICATE_SPEC`: Multiple children specify same implementation

### 7.4 Reconciliation Workflow

```
1. Detect Change → Set integrity_status = "DIRTY"
2. Analyze Impact → Scan all downstream citations
3. Generate Pending Items → Document conflicts
4. Human Review → Architect resolves conflicts
5. Update Tags → Modify content, citations
6. Validate Inventory → Recount tags, update manifest
7. Clear Dirty Flag → integrity_status = "CLEAN"

```

#### Example: Reconciliation After NFR Change

**Initial State:**

```
|NFR-3.3| ← |BRD-6.1|: "Memory (Core Queue): 1000 cap, ~10-50 MB."
|ICD-1|: core.queue_maxsize: 1000
|TDD-1|: self.queue = PriorityQueue(maxsize=config['queue_maxsize'])

```

**Change Event:**

```
MODIFIED: |NFR-3.3| → "Memory (Core Queue): 2000 cap, ~20-100 MB."

```

**Manifest Update:**

```yaml
:integrity_status: "DIRTY"
:pending_items:
  - target_tag: "ICD-1"
    source_trigger: "NFR-3.3"
    issue_type: "CONSTRAINT_VIOLATION"
    description: "Config schema specifies 1000, NFR now requires 2000."

```

**Resolution:**

```yaml
# Update ICD-1
core:
  queue_maxsize: 2000  # Updated per NFR-3.3 revision

# TDD-1 inherits automatically (no change needed - reads from config)

# Clear manifest
:integrity_status: "CLEAN"
:pending_items: []

```

----------
