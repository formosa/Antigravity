
## 17. Real-World Application: Complete Feature Lifecycle

### 17.1 Feature Request: "Multi-User Support"

**Initial Stakeholder Request:**

> "We need to support multiple user profiles so families can share one MAGGIE instance with personalized preferences and conversation history."

**Step 1: BRD Analysis (Strategist Persona)**
> **Embedded Example Type:** reStructuredText BRD directive
~~~rst
.. brd:: Multi-User Personalization
   :id: BRD-15

   Enable household-shared deployment with per-user preferences, conversation history, and voice profiles. Target: 60% of installs used by 2+ users within 3 months.

   SUCCESS METRICS:
   - Average users per installation: ≥2.3
   - User switching frequency: ≥5 switches/week
   - Preference satisfaction: ≥85% (user survey)
~~~

**Step 2: NFR Analysis (SysAdmin Persona)**
> **Embedded Example Type:** reStructuredText NFR directive
~~~rst
.. nfr:: Multi-User Constraints
   :id: NFR-15
   :links: BRD-15

.. nfr:: Storage per user: ≤500MB (10 users = 5GB total).
   :id: NFR-15.1
   :links: NFR-15

.. nfr:: User switch latency: ≤2s (model reload, history load).
   :id: NFR-15.2
   :links: NFR-15

.. nfr:: Profile encryption: AES-256, separate keys per user.
   :id: NFR-15.3
   :links: NFR-15

.. nfr:: Concurrent users: Max 1 active (hardware limit).
   :id: NFR-15.4
   :links: NFR-15

.. nfr:: Voice biometrics: ≥95% identification accuracy (Resemblyzer).
   :id: NFR-15.5
   :links: NFR-15
~~~

**Step 3: FSD Analysis (Product Manager Persona)**
> **Embedded Example Type:** reStructuredText FSD directive
~~~rst
.. fsd:: Multi-User Experience
   :id: FSD-16
   :links: NFR-15

.. fsd:: UI displays user selection screen on startup.
   :id: FSD-16.1
   :links: FSD-16

.. fsd:: Voice login: User says "Hey Maggie, it's [name]" → auto-switch.
   :id: FSD-16.2
   :links: FSD-16

.. fsd:: Visual: Avatar + name displayed in top-right corner.
   :id: FSD-16.3
   :links: FSD-16

.. fsd:: Conversation history filtered by active user_id.
   :id: FSD-16.4
   :links: FSD-16

.. fsd:: TTS voice preferences loaded from user profile.
   :id: FSD-16.5
   :links: FSD-16

.. fsd:: Manual switch: Settings → Users → Select → Confirm.
   :id: FSD-16.6
   :links: FSD-16
~~~

**Step 4: SAD Analysis (Architect Persona)**
> **Embedded Example Type:** reStructuredText SAD directive
~~~rst
.. sad:: Multi-User Architecture
   :id: SAD-14
   :links: FSD-16

.. sad:: Data Model: SQLite users table + per-user directories.
   :id: SAD-14.1
   :links: SAD-14

.. sad:: Pattern: Active user_id in session context (Core maintains).
   :id: SAD-14.2
   :links: SAD-14

.. sad:: Voice ID: Audio Process runs Resemblyzer on wake word.
   :id: SAD-14.3
   :links: SAD-14

.. sad:: User Switch Flow: 1. Audio detects voice → embedding to Core; 2. Core queries MemoryService; 3. Core loads profile; 4. Core broadcasts event.
   :id: SAD-14.4
   :links: SAD-14

.. sad:: Security: User-specific encryption keys derived from master key + user_id.
   :id: SAD-14.5
   :links: SAD-14
~~~

**Step 5: ICD Analysis (Data Engineer Persona)**
> **Embedded Example Type:** reStructuredText ICD directive
~~~rst
.. icd:: User Profile Schema (SQLite)
   :id: ICD-13
   :links: SAD-14.1

   .. code-block:: sql

      CREATE TABLE users (
          user_id TEXT PRIMARY KEY,
          display_name TEXT NOT NULL,
          voice_embedding BLOB,  -- 256-dim Resemblyzer vector
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          preferences TEXT  -- JSON: {tts_voice, theme, language}
      );

.. icd:: Voice ID Request
   :id: ICD-14
   :links: SAD-14.3

   .. code-block:: json

      {
        "command": "identify_user",
        "request_id": "uuid",
        "payload": {
          "audio_embedding": [0.123, -0.456, ...],
          "confidence_threshold": 0.85
        }
      }

.. icd:: User Switch Event (Broadcast)
   :id: ICD-15
   :links: SAD-14.4

   .. code-block:: json

      {
        "command": "USER_CHANGED",
        "priority": 0,
        "payload": {
          "user_id": "alice_profile_001",
          "display_name": "Alice",
          "preferences": {...}
        }
      }
~~~

**Step 6: TDD Analysis (Lead Developer Persona)**
> **Embedded Example Type:** reStructuredText TDD directive
~~~rst
.. tdd:: Component: UserManager
   :id: TDD-10
   :links: ICD-13, SAD-14

.. tdd:: Class: UserManager (runs in Core Process)
   :id: TDD-10.1
   :links: TDD-10

.. tdd:: Dependencies: sqlite3, cryptography
   :id: TDD-10.2
   :links: TDD-10

.. tdd:: Method: load_user(user_id: str) -> UserProfile
   :id: TDD-10.3
   :links: TDD-10

.. tdd:: Method: identify_from_voice(embedding: np.ndarray) -> str
   :id: TDD-10.4
   :links: TDD-10

.. tdd:: Method: switch_user(new_user_id: str) -> None
   :id: TDD-10.5
   :links: TDD-10

.. tdd:: Internal: active_user: UserProfile (session state)
   :id: TDD-10.6
   :links: TDD-10

.. tdd:: Internal: user_db: sqlite3.Connection
   :id: TDD-10.7
   :links: TDD-10

.. tdd:: Component: Audio VoiceIdentifier
   :id: TDD-11
   :links: ICD-14

.. tdd:: Class: VoiceIdentifier (in Audio Process)
   :id: TDD-11.1
   :links: TDD-11

.. tdd:: Dependencies: resemblyzer
   :id: TDD-11.2
   :links: TDD-11

.. tdd:: Method: extract_embedding(audio: np.ndarray) -> np.ndarray
   :id: TDD-11.3
   :links: TDD-11

.. tdd:: Internal: resemblyzer_model (CPU-based)
   :id: TDD-11.4
   :links: TDD-11
~~~

**Step 7: ISP Analysis (Code Generator Persona)**
> **Embedded Example Code:** Python class stub
~~~python
# |ISP-10|: "User Manager Implementation Stub"

import sqlite3
import json
import numpy as np
from dataclasses import dataclass
from cryptography.fernet import Fernet

@dataclass
class UserProfile:
    """
    User profile data structure.

    Attributes
    ----------
    user_id : str
        Unique identifier (|ICD-13|)
    display_name : str
        User-facing name
    preferences : dict
        TTS voice, theme, language settings
    voice_embedding : np.ndarray
        256-dim Resemblyzer vector (|ICD-14|)
    """
    user_id: str
    display_name: str
    preferences: dict
    voice_embedding: np.ndarray

class UserManager:
    """
    Manages user profiles, authentication, and session state.

    Implements
    ----------
    |TDD-10|, |FSD-16|

    Security
    --------
    |NFR-15.3|: Per-user AES-256 encryption

    Attributes
    ----------
    active_user : UserProfile
        Currently logged-in user (|TDD-10.6|)
    user_db : sqlite3.Connection
        SQLite database (|ICD-13|)
    """

    def __init__(self, db_path: str, master_key: bytes):
        """
        Initialize user manager with database connection.

        Parameters
        ----------
        db_path : str
            Path to users.db
        master_key : bytes
            Master encryption key (32 bytes)

        Implementation Notes
        --------------------
        1. Connect to SQLite database
        2. Create users table if not exists (|ICD-13|)
        3. Initialize active_user = None (no user logged in)
        4. Store master_key for deriving per-user keys

        References
        ----------
        |TDD-10.2|, |SAD-14.1|
        """
        pass

    def load_user(self, user_id: str) -> UserProfile:
        """
        Load user profile from database.

        Parameters
        ----------
        user_id : str
            User identifier

        Returns
        -------
        UserProfile
            Decrypted user profile object

        Raises
        ------
        ValueError
            If user_id not found in database

        Implementation Notes
        --------------------
        1. Query users table: SELECT * WHERE user_id = ?
        2. Decrypt preferences JSON using per-user key
        3. Deserialize voice_embedding BLOB to numpy array
        4. Construct UserProfile dataclass
        5. Return profile

        Performance
        -----------
        Must complete within 2s budget (|NFR-15.2|)

        References
        ----------
        |TDD-10.3|, |ICD-13|
        """
        pass

    def identify_from_voice(self, embedding: np.ndarray,
                            threshold: float = 0.85) -> str:
        """
        Identify user from voice embedding using cosine similarity.

        Parameters
        ----------
        embedding : np.ndarray
            256-dim Resemblyzer embedding from Audio Service
        threshold : float
            Minimum similarity score for positive ID (|NFR-15.5|)

        Returns
        -------
        str
            user_id of best match, or "unknown" if below threshold

        Implementation Notes
        --------------------
        1. Query all users: SELECT user_id, voice_embedding
        2. For each user:
           a. Compute cosine_similarity(embedding, user_embedding)
           b. Track best_match (user_id, score)
        3. If best_score >= threshold: return user_id
        4. Else: return "unknown"

        Performance
        -----------
        - Linear scan acceptable for ≤10 users (|NFR-15.4|)
        - Vectorize with numpy for speed

        References
        ----------
        |TDD-10.4|, |ICD-14|, |SAD-14.4|
        """
        pass

    def switch_user(self, new_user_id: str) -> None:
        """
        Switch active user and broadcast change event.

        Parameters
        ----------
        new_user_id : str
            Target user identifier

        Implementation Notes
        --------------------
        1. Load new user profile: profile = self.load_user(new_user_id)
        2. Update session: self.active_user = profile
        3. Construct USER_CHANGED event (|ICD-15|)
        4. Broadcast to all services via Core's routing
        5. Log user switch with request_id

        Side Effects
        ------------
        - All services receive USER_CHANGED and reload user-specific data
        - UI updates avatar and name display
        - Memory Service switches to user's conversation history

        References
        ----------
        |TDD-10.5|, |FSD-16.6|, |SAD-14.4|
        """
        pass
~~~

----------
