
## 17. Real-World Application: Complete Feature Lifecycle

### 17.1 Feature Request: "Multi-User Support"

**Initial Stakeholder Request:**

> "We need to support multiple user profiles so families can share one MAGGIE instance with personalized preferences and conversation history."

**Step 1: BRD Analysis (Strategist Persona)**

```
QUESTION: What is the business value?
ANSWER: Expands addressable market from individuals to households (3-5x users per installation).

QUESTION: What is the strategic objective?
ANSWER: Increase user engagement through personalization without sacrificing privacy.

GENERATED TAG:
|BRD-15|: "Multi-User Personalization"
Enable household-shared deployment with per-user preferences, conversation history,
and voice profiles. Target: 60% of installs used by 2+ users within 3 months.

SUCCESS METRICS:
- Average users per installation: ≥2.3
- User switching frequency: ≥5 switches/week
- Preference satisfaction: ≥85% (user survey)

```

**Step 2: NFR Analysis (SysAdmin Persona)**

```
QUESTION: What are the hard limits?
ANSWERS:
- Storage: Each user profile ~500MB (embeddings, history, preferences)
- Performance: User switching must complete <2s
- Security: Profiles must be encrypted separately (AES-256)
- Scalability: Support 1-10 users per installation

GENERATED TAGS:
|NFR-15| ← |BRD-15|: "Multi-User Constraints"
  |NFR-15.1|: Storage per user: ≤500MB (10 users = 5GB total).
  |NFR-15.2|: User switch latency: ≤2s (model reload, history load).
  |NFR-15.3|: Profile encryption: AES-256, separate keys per user.
  |NFR-15.4|: Concurrent users: Max 1 active (hardware limit).
  |NFR-15.5|: Voice biometrics: ≥95% identification accuracy (Resemblyzer).

```

**Step 3: FSD Analysis (Product Manager Persona)**

```
QUESTION: What does the user experience?
ANSWERS:
- Login screen on app start
- Voice-based authentication ("Hey Maggie, it's Alice")
- Visual indicator of current user
- User-specific conversation history sidebar
- Per-user TTS voice settings

GENERATED TAGS:
|FSD-16| ← |NFR-15|: "Multi-User Experience"
  |FSD-16.1|: UI displays user selection screen on startup.
  |FSD-16.2|: Voice login: User says "Hey Maggie, it's [name]" → auto-switch.
  |FSD-16.3|: Visual: Avatar + name displayed in top-right corner.
  |FSD-16.4|: Conversation history filtered by active user_id.
  |FSD-16.5|: TTS voice preferences loaded from user profile.
  |FSD-16.6|: Manual switch: Settings → Users → Select → Confirm.

```

**Step 4: SAD Analysis (Architect Persona)**

```
QUESTION: How do we structure this?
ANSWERS:
- New database table: users (id, name, voice_embedding, preferences_json)
- User profiles stored in ./users/{user_id}/ directory
- Voice biometrics run in Audio Process (CPU-only Resemblyzer)
- Current user_id propagated in all IPC messages (metadata)

GENERATED TAGS:
|SAD-14| ← |FSD-16|: "Multi-User Architecture"
  |SAD-14.1|: Data Model: SQLite users table + per-user directories.
  |SAD-14.2|: Pattern: Active user_id in session context (Core maintains).
  |SAD-14.3|: Voice ID: Audio Process runs Resemblyzer on wake word.
  |SAD-14.4|: User Switch Flow:
    1. Audio detects voice → sends embedding to Core
    2. Core queries MemoryService for user_id match
    3. Core loads user profile, updates session context
    4. Core broadcasts USER_CHANGED event to all services
  |SAD-14.5|: Security: User-specific encryption keys derived from master key + user_id.

```

**Step 5: ICD Analysis (Data Engineer Persona)**

```
QUESTION: What are the data contracts?
ANSWER: Define schemas for user profiles, voice embeddings, switch events.

GENERATED TAGS:
|ICD-13| ← |SAD-14.1|: "User Profile Schema (SQLite)"
CREATE TABLE users (
    user_id TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    voice_embedding BLOB,  -- 256-dim Resemblyzer vector
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    preferences TEXT  -- JSON: {tts_voice, theme, language}
);

|ICD-14| ← |SAD-14.3|: "Voice ID Request"
{
  "command": "identify_user",
  "request_id": "uuid",
  "payload": {
    "audio_embedding": [0.123, -0.456, ...],  // 256-dim array
    "confidence_threshold": 0.85
  }
}

|ICD-15| ← |SAD-14.4|: "User Switch Event (Broadcast)"
{
  "command": "USER_CHANGED",
  "priority": 0,  // High priority
  "payload": {
    "user_id": "alice_profile_001",
    "display_name": "Alice",
    "preferences": {...}
  }
}

```

**Step 6: TDD Analysis (Lead Developer Persona)**

```
QUESTION: What components implement this?
ANSWER: New UserManager in Core, UI components, Audio voice ID.

GENERATED TAGS:
|TDD-10| ← |ICD-13|, |SAD-14|: "Component: UserManager"
  |TDD-10.1|: Class: UserManager (runs in Core Process)
  |TDD-10.2|: Dependencies: sqlite3, cryptography
  |TDD-10.3|: Method: load_user(user_id: str) -> UserProfile
  |TDD-10.4|: Method: identify_from_voice(embedding: np.ndarray) -> str
  |TDD-10.5|: Method: switch_user(new_user_id: str) -> None
  |TDD-10.6|: Internal: active_user: UserProfile (session state)
  |TDD-10.7|: Internal: user_db: sqlite3.Connection

|TDD-11| ← |ICD-14|: "Component: Audio VoiceIdentifier"
  |TDD-11.1|: Class: VoiceIdentifier (in Audio Process)
  |TDD-11.2|: Dependencies: resemblyzer
  |TDD-11.3|: Method: extract_embedding(audio: np.ndarray) -> np.ndarray
  |TDD-11.4|: Internal: resemblyzer_model (CPU-based)

```

**Step 7: ISP Analysis (Code Generator Persona)**

```python
|ISP-10| ← |TDD-10|:

import sqlite3
import json
import numpy as np
from dataclasses import dataclass
from cryptography.fernet import Fernet

@dataclass
class UserProfile:
    """
    User profile data structure.

    Attributes
    ----------
    user_id : str
        Unique identifier (|ICD-13|)
    display_name : str
        User-facing name
    preferences : dict
        TTS voice, theme, language settings
    voice_embedding : np.ndarray
        256-dim Resemblyzer vector (|ICD-14|)
    """
    user_id: str
    display_name: str
    preferences: dict
    voice_embedding: np.ndarray

class UserManager:
    """
    Manages user profiles, authentication, and session state.

    Implements
    ----------
    |TDD-10|, |FSD-16|

    Security
    --------
    |NFR-15.3|: Per-user AES-256 encryption

    Attributes
    ----------
    active_user : UserProfile
        Currently logged-in user (|TDD-10.6|)
    user_db : sqlite3.Connection
        SQLite database (|ICD-13|)
    """

    def __init__(self, db_path: str, master_key: bytes):
        """
        Initialize user manager with database connection.

        Parameters
        ----------
        db_path : str
            Path to users.db
        master_key : bytes
            Master encryption key (32 bytes)

        Implementation Notes
        --------------------
        1. Connect to SQLite database
        2. Create users table if not exists (|ICD-13|)
        3. Initialize active_user = None (no user logged in)
        4. Store master_key for deriving per-user keys

        References
        ----------
        |TDD-10.2|, |SAD-14.1|
        """
        pass

    def load_user(self, user_id: str) -> UserProfile:
        """
        Load user profile from database.

        Parameters
        ----------
        user_id : str
            User identifier

        Returns
        -------
        UserProfile
            Decrypted user profile object

        Raises
        ------
        ValueError
            If user_id not found in database

        Implementation Notes
        --------------------
        1. Query users table: SELECT * WHERE user_id = ?
        2. Decrypt preferences JSON using per-user key
        3. Deserialize voice_embedding BLOB to numpy array
        4. Construct UserProfile dataclass
        5. Return profile

        Performance
        -----------
        Must complete within 2s budget (|NFR-15.2|)

        References
        ----------
        |TDD-10.3|, |ICD-13|
        """
        pass

    def identify_from_voice(self, embedding: np.ndarray,
                            threshold: float = 0.85) -> str:
        """
        Identify user from voice embedding using cosine similarity.

        Parameters
        ----------
        embedding : np.ndarray
            256-dim Resemblyzer embedding from Audio Service
        threshold : float
            Minimum similarity score for positive ID (|NFR-15.5|)

        Returns
        -------
        str
            user_id of best match, or "unknown" if below threshold

        Implementation Notes
        --------------------
        1. Query all users: SELECT user_id, voice_embedding
        2. For each user:
           a. Compute cosine_similarity(embedding, user_embedding)
           b. Track best_match (user_id, score)
        3. If best_score >= threshold: return user_id
        4. Else: return "unknown"

        Performance
        -----------
        - Linear scan acceptable for ≤10 users (|NFR-15.4|)
        - Vectorize with numpy for speed

        References
        ----------
        |TDD-10.4|, |ICD-14|, |SAD-14.4|
        """
        pass

    def switch_user(self, new_user_id: str) -> None:
        """
        Switch active user and broadcast change event.

        Parameters
        ----------
        new_user_id : str
            Target user identifier

        Implementation Notes
        --------------------
        1. Load new user profile: profile = self.load_user(new_user_id)
        2. Update session: self.active_user = profile
        3. Construct USER_CHANGED event (|ICD-15|)
        4. Broadcast to all services via Core's routing
        5. Log user switch with request_id

        Side Effects
        ------------
        - All services receive USER_CHANGED and reload user-specific data
        - UI updates avatar and name display
        - Memory Service switches to user's conversation history

        References
        ----------
        |TDD-10.5|, |FSD-16.6|, |SAD-14.4|
        """
        pass

```

----------
